<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#FFFBF0">
    <title>我的福岡癒旅 (Safety+)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&family=Zen+Maru+Gothic:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'jp-bg': '#FFFBF0', 
                        'jp-card': '#FFFFFF',
                        'jp-yellow': '#F3E4B2', 
                        'jp-text': '#595045', 
                        'jp-accent': '#D4A373', 
                        'jp-red': '#EF4444',
                        'jp-blue-light': '#E0F2FE',
                    },
                    fontFamily: {
                        sans: ['Zen Maru Gothic', 'Noto Sans JP', 'sans-serif'],
                    },
                    animation: {
                        'pulse-fast': 'pulse 1s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    }
                }
            }
        }
    </script>
    <style>
        body { -webkit-tap-highlight-color: transparent; overscroll-behavior-y: none; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .page-enter { animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        .modal-enter { animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(100%); } to { opacity: 1; transform: translateY(0); } }
        .glass { background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.5); }
        .siren-active { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both infinite; background-color: #EF4444 !important; color: white !important; border-color: #EF4444 !important; }
        @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }
    </style>
</head>
<body class="bg-jp-bg text-jp-text h-[100dvh] w-full flex flex-col overflow-hidden font-sans select-none">

    <header class="px-6 pt-12 pb-4 flex justify-between items-center bg-jp-bg z-30 relative">
        <div onclick="openTaxiCard()" class="cursor-pointer group">
            <h1 id="app-title" class="text-2xl font-bold tracking-widest text-jp-text flex items-center gap-2">
                FUKUOKA <i class="fa-solid fa-taxi text-xs text-white bg-jp-accent p-1.5 rounded-full group-active:scale-110 transition"></i>
            </h1>
            <p id="app-subtitle" class="text-xs text-gray-400 mt-1 tracking-wider">避年療癒之旅 2026</p>
        </div>
        
        <div class="flex gap-3">
            <button onclick="openModal('safety')" class="relative p-3 rounded-full bg-red-50 text-red-500 shadow-sm border border-red-100 active:scale-95 transition">
                <i class="fa-solid fa-shield-halved text-lg"></i>
            </button>
            <button onclick="toggleMainMenu()" class="relative p-3 rounded-full bg-white shadow-sm active:scale-95 transition">
                <i class="fa-solid fa-bars text-lg text-jp-text"></i>
                <span id="global-badge" class="absolute top-1 right-1 w-2.5 h-2.5 bg-red-400 rounded-full border-2 border-white hidden"></span>
            </button>
        </div>

        <div id="main-menu" class="hidden absolute top-24 right-6 w-64 glass rounded-2xl shadow-[0_10px_40px_-10px_rgba(0,0,0,0.1)] p-2 z-50 transform origin-top-right transition-all duration-200">
            <button onclick="openModal('luggage')" class="menu-item w-full text-left px-4 py-3 rounded-xl hover:bg-white/50 flex items-center gap-3 transition">
                <i class="fa-solid fa-suitcase text-purple-400 w-5"></i> 行李清單
                <span id="menu-badge-luggage" class="ml-auto text-[10px] bg-red-100 text-red-500 px-2 py-0.5 rounded-full hidden">0</span>
            </button>
            <button onclick="openModal('shopping')" class="menu-item w-full text-left px-4 py-3 rounded-xl hover:bg-white/50 flex items-center gap-3 transition">
                <i class="fa-solid fa-bag-shopping text-pink-400 w-5"></i> 購物清單
                <span id="menu-badge-shop" class="ml-auto text-[10px] bg-red-100 text-red-500 px-2 py-0.5 rounded-full hidden">0</span>
            </button>
            <button onclick="openModal('todo')" class="menu-item w-full text-left px-4 py-3 rounded-xl hover:bg-white/50 flex items-center gap-3 transition">
                <i class="fa-solid fa-check-circle text-blue-400 w-5"></i> 待辦事項
            </button>
            <div class="my-2 border-t border-gray-100/50"></div>
            <button onclick="exportData()" class="menu-item w-full text-left px-4 py-3 rounded-xl hover:bg-white/50 flex items-center gap-3 transition text-sm">
                <i class="fa-solid fa-download text-gray-400 w-5"></i> 備份行程
            </button>
            <button onclick="document.getElementById('file-input').click()" class="menu-item w-full text-left px-4 py-3 rounded-xl hover:bg-white/50 flex items-center gap-3 transition text-sm">
                <i class="fa-solid fa-upload text-gray-400 w-5"></i> 還原行程
            </button>
            <input type="file" id="file-input" class="hidden" accept=".json" onchange="importData(this)">
        </div>
        <div id="menu-overlay" onclick="toggleMainMenu()" class="hidden fixed inset-0 z-40 bg-black/5"></div>
    </header>

    <div class="pl-6 py-2 bg-jp-bg z-10">
        <div id="date-slider" class="flex gap-4 overflow-x-auto no-scrollbar pr-6 pb-4"></div>
    </div>

    <main id="main-container" class="flex-1 overflow-y-auto px-6 pb-32 relative scroll-smooth no-scrollbar">
        
        <div id="view-itinerary" class="page-enter space-y-5">
            <div id="weather-widget" class="bg-white/60 border border-white backdrop-blur-sm p-4 rounded-3xl shadow-sm flex items-center justify-between hidden">
                <div class="flex items-center gap-4">
                    <div id="weather-icon" class="text-3xl text-orange-400"><i class="fa-solid fa-sun"></i></div>
                    <div>
                        <div class="text-[10px] text-gray-400 font-bold mb-0.5 tracking-wider uppercase">Forecast</div>
                        <div class="text-xl font-bold text-jp-text" id="weather-temp">--°C</div>
                    </div>
                </div>
                <div class="text-right">
                    <div class="text-xs text-blue-500 bg-blue-50 px-3 py-1 rounded-full font-bold" id="weather-desc">晴朗</div>
                </div>
            </div>

            <div class="flex justify-between items-end px-1">
                <h2 class="text-lg font-bold text-jp-text">今日計畫</h2>
                <div class="text-[10px] text-gray-400 bg-white px-2 py-1 rounded-full shadow-sm">長按拖曳</div>
            </div>
            <div id="itinerary-list" class="space-y-4 pb-10"></div>
            
            <button onclick="openAddModal('itinerary')" class="w-full py-4 rounded-2xl border-2 border-dashed border-jp-accent/30 text-jp-accent font-bold hover:bg-white transition flex justify-center items-center gap-2 group">
                <i class="fa-solid fa-plus group-hover:scale-110 transition"></i> 新增行程
            </button>
        </div>

        <div id="view-map" class="hidden h-full flex flex-col page-enter">
            <div class="bg-white p-3 rounded-2xl shadow-sm mb-3 text-sm flex gap-2 items-center justify-between z-10">
                <div class="flex items-center gap-2 text-xs text-gray-500">
                    <i class="fa-solid fa-location-dot text-red-400"></i>
                    <span id="map-status">載入中...</span>
                </div>
                <button onclick="refreshMap()" class="text-[10px] text-blue-500 bg-blue-50 px-3 py-1.5 rounded-full font-bold">重整</button>
            </div>
            <div id="osm-map" class="flex-1 w-full rounded-[2rem] overflow-hidden shadow-inner bg-gray-100 relative z-0 border-4 border-white"></div>
        </div>

        <div id="view-finance" class="hidden page-enter space-y-6">
            <div class="bg-gradient-to-br from-jp-text to-gray-700 rounded-3xl p-6 text-white shadow-lg shadow-gray-200">
                <div class="text-xs text-white/60 mb-1">本日總支出</div>
                <div class="flex items-baseline gap-1">
                    <span class="text-3xl font-bold currency-icon-foreign">¥</span>
                    <span class="text-4xl font-bold" id="daily-total-foreign">0</span>
                </div>
                <div class="mt-2 text-sm text-white/60 flex justify-between items-center">
                    <span>約 <span class="currency-icon-home">$</span> <span id="daily-total-home">0</span></span>
                    <button onclick="openAddModal('expense')" class="bg-white/20 hover:bg-white/30 px-3 py-1.5 rounded-full text-xs transition backdrop-blur-md">
                        <i class="fa-solid fa-plus mr-1"></i> 記一筆
                    </button>
                </div>
            </div>
            <div id="expense-list" class="space-y-3 pb-20"></div>
        </div>

        <div id="view-info" class="hidden page-enter space-y-5">
             <div class="flex justify-between items-center">
                <h2 class="text-lg font-bold">旅人筆記</h2>
                <button onclick="openAddModal('info')" class="text-jp-accent w-8 h-8 flex items-center justify-center bg-white rounded-full shadow-sm"><i class="fa-solid fa-plus"></i></button>
            </div>
            <div id="info-list" class="grid grid-cols-1 gap-4 pb-20"></div>
        </div>
    </main>

    <nav class="fixed bottom-6 left-6 right-6 glass h-16 px-6 flex justify-between items-center rounded-full shadow-[0_8px_30px_rgba(0,0,0,0.08)] z-40 mx-auto max-w-md">
        <button onclick="switchTab('itinerary')" class="nav-btn active relative w-12 h-12 flex items-center justify-center rounded-full transition-all duration-300 text-jp-accent bg-jp-bg"><i class="fa-solid fa-calendar-day text-lg"></i></button>
        <button onclick="switchTab('map')" class="nav-btn w-12 h-12 flex items-center justify-center rounded-full transition-all duration-300 text-gray-300 hover:text-jp-text"><i class="fa-solid fa-map text-lg"></i></button>
        <button onclick="switchTab('finance')" class="nav-btn w-12 h-12 flex items-center justify-center rounded-full transition-all duration-300 text-gray-300 hover:text-jp-text"><i class="fa-solid fa-wallet text-lg"></i></button>
        <button onclick="openModal('converter')" class="nav-btn w-12 h-12 flex items-center justify-center rounded-full transition-all duration-300 text-gray-300 hover:text-jp-text"><i class="fa-solid fa-calculator text-lg"></i></button>
    </nav>

    <div id="modal-safety" class="fixed inset-0 bg-red-50/90 backdrop-blur-md z-[60] hidden flex flex-col justify-end">
        <div class="bg-white w-full rounded-t-[2.5rem] p-6 pb-10 modal-enter shadow-[0_-10px_60px_rgba(239,68,68,0.2)]">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold flex items-center gap-2 text-red-500"><i class="fa-solid fa-shield-heart"></i> 安全守護</h2>
                <button onclick="closeModal('safety')" class="w-8 h-8 flex items-center justify-center bg-gray-50 rounded-full text-gray-300"><i class="fa-solid fa-xmark"></i></button>
            </div>

            <button id="siren-btn" onclick="toggleSiren()" class="w-full py-5 bg-white border-2 border-red-100 rounded-2xl flex items-center justify-center gap-3 text-red-500 font-bold mb-6 shadow-sm active:scale-[0.98] transition">
                <i class="fa-solid fa-bullhorn text-2xl"></i>
                <span id="siren-text">啟動防狼警報 (最大聲)</span>
            </button>

            <div class="mb-6">
                <label class="text-xs text-gray-400 font-bold ml-1 mb-2 block">一鍵報平安 (WhatsApp)</label>
                <div class="flex gap-2 mb-2">
                    <input type="tel" id="safety-contact" class="flex-1 bg-gray-50 px-4 py-3 rounded-xl text-sm outline-none border border-gray-100" placeholder="輸入聯絡人電話 (含區號 例如 85291234567)">
                    <button onclick="saveContact()" class="bg-gray-800 text-white px-4 rounded-xl text-xs font-bold whitespace-nowrap">儲存</button>
                </div>
                <button onclick="sendWhatsAppSOS()" class="w-full bg-[#25D366] text-white py-4 rounded-xl font-bold flex items-center justify-center gap-2 shadow-lg shadow-green-100 active:scale-[0.98] transition">
                    <i class="fa-brands fa-whatsapp text-xl"></i> 傳送位置報平安
                </button>
                <p class="text-[10px] text-gray-300 mt-2 text-center">*點擊後會開啟 WhatsApp 並預填 Google Maps 連結</p>
            </div>

            <div class="grid grid-cols-3 gap-3 pt-4 border-t border-gray-100">
                <button onclick="openNearby('police')" class="flex flex-col items-center gap-2 p-3 rounded-xl bg-blue-50 text-blue-500 hover:bg-blue-100 transition">
                    <i class="fa-solid fa-building-shield text-xl"></i>
                    <span class="text-xs font-bold">派出所</span>
                </button>
                <button onclick="openNearby('hospital')" class="flex flex-col items-center gap-2 p-3 rounded-xl bg-red-50 text-red-500 hover:bg-red-100 transition">
                    <i class="fa-solid fa-hospital text-xl"></i>
                    <span class="text-xs font-bold">醫院</span>
                </button>
                <button onclick="openNearby('convenience_store')" class="flex flex-col items-center gap-2 p-3 rounded-xl bg-orange-50 text-orange-500 hover:bg-orange-100 transition">
                    <i class="fa-solid fa-store text-xl"></i>
                    <span class="text-xs font-bold">便利店</span>
                </button>
            </div>
        </div>
    </div>

    <div id="modal-taxi" class="fixed inset-0 bg-jp-text z-[70] hidden flex flex-col items-center justify-center p-6 text-center page-enter" onclick="closeModal('taxi')">
        <div class="text-white/50 text-sm mb-4 animate-pulse">請出示此畫面給司機</div>
        <div class="bg-white text-black p-8 rounded-xl w-full max-w-sm shadow-2xl transform rotate-1">
            <h2 class="text-2xl font-bold mb-4 border-b-2 border-black pb-2">ホテルへお願いします</h2>
            <p class="text-2xl font-bold mb-4 leading-tight">Hotel Wing International<br>Hakata Shinkansenguchi</p>
            <p class="text-lg font-bold text-gray-500 mb-1">住所：</p>
            <p class="text-xl font-bold bg-yellow-100 p-3 rounded leading-relaxed">福岡市博多区博多駅東<br>1-17-17</p>
        </div>
        <div class="mt-8 text-white/50 text-xs"><i class="fa-solid fa-hand-point-up mr-2"></i>點擊任意處關閉</div>
    </div>

    <div id="modal-converter" class="fixed inset-0 bg-black/40 backdrop-blur-sm z-50 hidden flex items-center justify-center px-6">
        <div class="bg-white w-full max-w-xs rounded-[2rem] p-6 page-enter shadow-2xl relative">
            <button onclick="closeModal('converter')" class="absolute top-4 right-4 w-8 h-8 flex items-center justify-center bg-gray-50 rounded-full text-gray-300"><i class="fa-solid fa-xmark"></i></button>
            <h3 class="font-bold mb-6 text-jp-text text-center">即時匯率換算</h3>
            <div class="bg-jp-bg rounded-2xl p-4 mb-2 border border-orange-100">
                <label class="text-[10px] text-gray-400 block mb-1 font-bold tracking-wider"><span class="currency-foreign">JPY</span></label>
                <div class="flex items-center"><span class="text-xl font-bold mr-2 text-jp-accent currency-icon-foreign">¥</span><input type="number" id="conv-foreign" class="bg-transparent text-3xl font-bold w-full outline-none text-jp-text" placeholder="0" oninput="convertCurrency('foreign')"></div>
            </div>
            <div class="flex justify-center -my-5 relative z-10"><div class="bg-white border border-gray-100 rounded-full p-2 shadow-sm"><i class="fa-solid fa-arrow-down-up text-gray-300 text-xs"></i></div></div>
            <div class="bg-gray-50 rounded-2xl p-4 mt-2 border border-gray-100">
                <label class="text-[10px] text-gray-400 block mb-1 font-bold tracking-wider"><span class="currency-home">HKD</span> <span class="text-[10px] ml-1 bg-gray-200 px-1 rounded text-gray-500" id="rate-display"></span></label>
                <div class="flex items-center"><span class="text-xl font-bold mr-2 text-gray-400 currency-icon-home">$</span><input type="number" id="conv-home" class="bg-transparent text-3xl font-bold w-full outline-none text-gray-500" placeholder="0" oninput="convertCurrency('home')"></div>
            </div>
        </div>
    </div>

    <div id="modal-generic" class="fixed inset-0 bg-black/30 backdrop-blur-sm z-50 hidden flex justify-end">
        <div class="bg-jp-bg w-full max-w-md h-full shadow-2xl flex flex-col modal-enter relative rounded-l-3xl overflow-hidden">
            <div class="p-6 bg-white flex justify-between items-center shadow-sm z-10">
                <h2 id="generic-title" class="text-xl font-bold flex items-center gap-2 text-jp-text">清單</h2>
                <button onclick="closeGenericModal()" class="w-8 h-8 flex items-center justify-center bg-gray-50 rounded-full text-gray-400"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="p-4 bg-white/50 border-b border-white">
                <div class="flex gap-2">
                    <input type="text" id="generic-input" class="flex-1 bg-white rounded-xl px-4 py-3 outline-none text-sm shadow-sm border border-gray-100 placeholder-gray-300 transition focus:border-jp-accent" placeholder="新增項目...">
                    <button onclick="addGenericItem()" class="bg-jp-text text-white w-12 rounded-xl shadow-lg shadow-gray-200"><i class="fa-solid fa-plus"></i></button>
                </div>
            </div>
            <ul id="generic-list" class="flex-1 overflow-y-auto p-4 space-y-3 pb-10"></ul>
        </div>
    </div>

    <div id="detail-modal" class="fixed inset-0 bg-black/40 backdrop-blur-md z-50 hidden flex items-end sm:items-center justify-center">
        <div class="bg-white w-full sm:w-96 rounded-t-[2.5rem] sm:rounded-[2.5rem] p-8 pb-10 page-enter relative max-h-[85vh] overflow-y-auto no-scrollbar shadow-[0_-10px_40px_rgba(0,0,0,0.2)]">
            <div class="absolute top-3 left-1/2 -translate-x-1/2 w-12 h-1.5 bg-gray-200 rounded-full sm:hidden"></div>
            <div class="flex flex-col items-center mb-6">
                <div id="detail-icon-bg" class="w-20 h-20 rounded-full flex items-center justify-center text-3xl mb-4 shadow-lg ring-4 ring-white"><i id="detail-icon" class="fa-solid"></i></div>
                <h2 id="detail-title" class="text-2xl font-bold text-jp-text text-center leading-tight">標題</h2>
                <div id="detail-time" class="text-jp-accent font-bold mt-2 bg-orange-50 px-3 py-1 rounded-full text-sm font-mono"></div>
            </div>
            <div class="space-y-4">
                <div id="detail-booking-container" class="hidden">
                    <div class="bg-jp-blue-light p-5 rounded-2xl border border-blue-100 relative overflow-hidden group">
                        <div class="absolute -right-4 -bottom-4 text-blue-200 text-7xl opacity-30 rotate-12 group-hover:rotate-0 transition duration-500"><i class="fa-solid fa-ticket"></i></div>
                        <div class="relative z-10">
                            <div class="text-[10px] text-blue-400 font-bold mb-1 uppercase tracking-widest">Booking Info</div>
                            <div class="text-xs text-gray-500 mb-1" id="detail-bk-platform">平台</div>
                            <div class="text-2xl font-bold text-jp-blue-text font-mono tracking-wider" id="detail-bk-ref">#</div>
                        </div>
                    </div>
                </div>
                <button onclick="openExternalMap()" class="w-full flex items-center justify-between bg-gray-50 text-gray-600 p-4 rounded-2xl border border-gray-100 active:bg-gray-100 transition">
                    <div class="flex items-center gap-3 overflow-hidden">
                        <div class="w-8 h-8 rounded-full bg-white flex items-center justify-center text-red-500 shadow-sm flex-shrink-0"><i class="fa-solid fa-location-dot"></i></div>
                        <span id="detail-loc" class="font-bold text-sm truncate">地點名稱</span>
                    </div>
                    <i class="fa-solid fa-arrow-up-right-from-square text-xs text-gray-400"></i>
                </button>
                <div class="bg-jp-bg p-5 rounded-2xl border border-orange-50">
                    <div class="text-[10px] text-gray-400 mb-2 font-bold uppercase tracking-wider">Note</div>
                    <div id="detail-note" class="text-sm text-gray-600 leading-relaxed whitespace-pre-line"></div>
                </div>
            </div>
            <div class="flex gap-3 mt-8">
                <button onclick="closeDetailModal()" class="flex-1 py-3 text-gray-400 font-bold rounded-xl hover:bg-gray-50 transition">關閉</button>
                <button onclick="deleteFromDetail()" class="flex-1 py-3 bg-red-50 text-red-400 font-bold rounded-xl hover:bg-red-100 transition"><i class="fa-solid fa-trash-can mr-2"></i>刪除</button>
            </div>
        </div>
    </div>

    <div id="add-modal" class="fixed inset-0 bg-black/40 backdrop-blur-sm z-50 hidden flex items-end sm:items-center justify-center">
        <div class="bg-white w-full sm:w-96 rounded-t-3xl sm:rounded-3xl p-6 pb-8 page-enter relative max-h-[90vh] overflow-y-auto no-scrollbar">
            <div class="flex justify-between items-center mb-6">
                <h3 id="modal-title" class="text-xl font-bold text-jp-text">新增</h3>
                <button onclick="closeAddModal()" class="w-8 h-8 bg-gray-50 rounded-full text-gray-300"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <form id="add-form" onsubmit="handleFormSubmit(event)" class="space-y-4">
                <div id="modal-content"></div>
                <button type="submit" class="w-full bg-jp-text text-white font-bold py-4 rounded-xl shadow-lg mt-6 active:scale-[0.98] transition">確認儲存</button>
            </form>
        </div>
    </div>

    <script>
        const CONFIG = {
            key: "fukuoka_safety_v4",
            dates: ["2026-02-14", "2026-02-15", "2026-02-16", "2026-02-17", "2026-02-18", "2026-02-19", "2026-02-20"],
            rate: 0.052,
            hotel: { jp: "福岡市博多区博多駅東1-17-17", name: "Hotel Wing International", coords: [33.5910, 130.4225] },
            defaultItinerary: [
                 { id: 1, date: "2026-02-14", time: "18:45", type: "shopping", title: "住吉酒販 (角打)", loc: "Hakata Deitos Annex", lat: 33.5905, lng: 130.4195, note: "體驗日式角打", bookingRef: "" }
            ]
        };

        const CATS = {
            sightseeing: { label: "景點", icon: "fa-camera", color: "text-green-600", bg: "bg-green-100" },
            transport: { label: "交通", icon: "fa-train", color: "text-blue-600", bg: "bg-blue-100" },
            flight: { label: "航班", icon: "fa-plane-up", color: "text-sky-600", bg: "bg-sky-100" },
            food: { label: "美食", icon: "fa-utensils", color: "text-orange-600", bg: "bg-orange-100" },
            shopping: { label: "購物", icon: "fa-bag-shopping", color: "text-pink-600", bg: "bg-pink-100" },
            other: { label: "其他", icon: "fa-star", color: "text-purple-600", bg: "bg-purple-100" }
        };

        let db = { itinerary: [], expenses: [], shopping: [], todo: [], luggage: [], info: [], settings: { safetyContact: "" } };
        let state = { date: CONFIG.dates[0], tab: 'itinerary', currentList: null, currentItem: null };
        let map = null, markers = [];

        // --- CORE ---
        function init() {
            const saved = localStorage.getItem(CONFIG.key);
            if (saved) db = JSON.parse(saved);
            else {
                db.itinerary = CONFIG.defaultItinerary;
                db.luggage = ["護照", "現金", "網卡", "充電器", "常備藥", "保養品", "防狼警報器"].map((t,i)=>({id:i, text:t, done:false}));
            }
            if(!db.settings) db.settings = { safetyContact: "" };
            
            // Restore Safety Contact
            if(db.settings.safetyContact) document.getElementById('safety-contact').value = db.settings.safetyContact;

            renderDateSlider();
            renderAll();
            document.getElementById('rate-display').innerText = CONFIG.rate;
            fetchWeather();
        }

        function save() { localStorage.setItem(CONFIG.key, JSON.stringify(db)); renderAll(); }
        function renderAll() { renderItinerary(); renderExpenses(); renderInfo(); updateBadges(); }

        // --- SAFETY FEATURES (NEW) ---
        function saveContact() {
            const val = document.getElementById('safety-contact').value;
            db.settings.safetyContact = val;
            save();
            alert("緊急聯絡人已儲存！");
        }

        function sendWhatsAppSOS() {
            const contact = db.settings.safetyContact;
            if(!contact) { alert("請先輸入聯絡人電話！"); return; }
            
            if(navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (p) => {
                        const lat = p.coords.latitude;
                        const lng = p.coords.longitude;
                        const mapLink = `https://www.google.com/maps?q=${lat},${lng}`;
                        const msg = `【緊急報平安】我現在在這裡，一切平安。\n位置：${mapLink}`;
                        const url = `https://wa.me/${contact}?text=${encodeURIComponent(msg)}`;
                        window.location.href = url;
                    },
                    (e) => {
                        alert("無法取得位置，將發送純文字訊息。");
                        const url = `https://wa.me/${contact}?text=${encodeURIComponent("【緊急報平安】我現在很安全，但無法取得 GPS 位置。")}`;
                        window.location.href = url;
                    }
                );
            } else {
                alert("瀏覽器不支援定位");
            }
        }

        let audioContext = null;
        let oscillator = null;
        let isSirenOn = false;

        function toggleSiren() {
            const btn = document.getElementById('siren-btn');
            const txt = document.getElementById('siren-text');
            
            if (isSirenOn) {
                // Stop Siren
                if(oscillator) { oscillator.stop(); oscillator.disconnect(); oscillator = null; }
                isSirenOn = false;
                btn.classList.remove('siren-active');
                txt.innerText = "啟動防狼警報 (最大聲)";
            } else {
                // Start Siren
                if (!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.type = 'sawtooth'; // Harsh sound
                oscillator.frequency.setValueAtTime(800, audioContext.currentTime); // Start freq
                
                // Modulate frequency to create siren effect
                oscillator.frequency.linearRampToValueAtTime(1200, audioContext.currentTime + 0.3);
                
                // Loop the siren effect using standard JS interval is easier for this simple implementation
                // But for pure Web Audio API, we usually use an LFO. Here we just make a constant loud noise for simplicity and reliability.
                // Let's make it a dual-tone alarm.
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                // LFO for Wailing
                const lfo = audioContext.createOscillator();
                lfo.type = 'square';
                lfo.frequency.value = 4; // 4 times per second
                const lfoGain = audioContext.createGain();
                lfoGain.gain.value = 400; // Modulate by +/- 400Hz
                lfo.connect(lfoGain);
                lfoGain.connect(oscillator.frequency);
                lfo.start();

                oscillator.start();
                
                isSirenOn = true;
                btn.classList.add('siren-active');
                txt.innerText = "警報響起中！點擊關閉";
            }
        }

        function openNearby(type) {
            if(navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(p => {
                    const lat = p.coords.latitude;
                    const lng = p.coords.longitude;
                    // Japanese keywords: 交番(Police), 病院(Hospital), コンビニ(Convenience Store)
                    let query = "";
                    if(type === 'police') query = "交番";
                    else if(type === 'hospital') query = "病院";
                    else query = "コンビニ";
                    
                    window.open(`https://www.google.com/maps/search/${query}/@${lat},${lng},15z`);
                });
            } else {
                alert("請允許定位權限");
            }
        }

        // --- ITINERARY ---
        function renderDateSlider() {
            const el = document.getElementById('date-slider');
            el.innerHTML = CONFIG.dates.map(d => {
                const dateObj = new Date(d);
                const day = dateObj.getDate();
                const week = dateObj.toLocaleDateString('zh-HK',{weekday:'short'});
                const active = d === state.date ? "bg-jp-text text-white shadow-lg scale-105" : "bg-white text-gray-300";
                return `<button onclick="setDate('${d}')" class="flex-shrink-0 flex flex-col items-center justify-center w-14 h-16 rounded-2xl transition-all duration-300 ${active}">
                    <span class="text-[10px] opacity-80">${week}</span><span class="text-xl font-bold font-mono">${day}</span>
                </button>`;
            }).join('');
        }
        function setDate(d) { state.date = d; renderDateSlider(); renderItinerary(); renderExpenses(); updateMap(); }

        function renderItinerary() {
            const list = document.getElementById('itinerary-list');
            const items = db.itinerary.filter(i => i.date === state.date).sort((a,b) => a.time.localeCompare(b.time));
            if(items.length === 0) { list.innerHTML = `<div class="text-center py-12"><div class="text-6xl text-gray-200 mb-4"><i class="fa-solid fa-mug-hot"></i></div><p class="text-gray-400 text-sm">今天想做點什麼？</p></div>`; return; }
            list.innerHTML = items.map(i => {
                const cat = CATS[i.type] || CATS.other;
                return `<div onclick="openDetail(${i.id})" class="bg-white p-4 rounded-3xl shadow-[0_2px_15px_rgba(0,0,0,0.03)] flex gap-4 items-center group active:scale-[0.98] transition cursor-pointer border border-transparent hover:border-gray-100">
                    <div class="flex flex-col items-center gap-1 w-12 font-mono text-gray-400 text-sm font-bold"><span>${i.time}</span>${i.bookingRef ? '<i class="fa-solid fa-circle text-[6px] text-jp-accent"></i>' : ''}</div>
                    <div class="w-12 h-12 rounded-2xl ${cat.bg} ${cat.color} flex items-center justify-center text-lg shadow-sm"><i class="fa-solid ${cat.icon}"></i></div>
                    <div class="flex-1 min-w-0"><h3 class="font-bold text-jp-text truncate text-base">${i.title}</h3><div class="text-xs text-gray-400 truncate"><i class="fa-solid fa-location-dot mr-1 opacity-50"></i>${i.loc || '未設定地點'}</div></div>
                </div>`;
            }).join('');
            new Sortable(list, { animation: 150, handle: '.group' });
        }

        // --- DETAILS ---
        function openDetail(id) {
            const item = db.itinerary.find(i => i.id === id);
            if(!item) return;
            state.currentItem = item;
            const cat = CATS[item.type] || CATS.other;
            document.getElementById('detail-title').innerText = item.title;
            document.getElementById('detail-time').innerText = `${item.date} · ${item.time}`;
            document.getElementById('detail-icon').className = `fa-solid ${cat.icon} ${cat.color}`;
            document.getElementById('detail-icon-bg').className = `w-20 h-20 rounded-full flex items-center justify-center text-3xl mb-4 shadow-lg ring-4 ring-white ${cat.bg}`;
            document.getElementById('detail-loc').innerText = item.loc || "點擊搜尋地圖";
            document.getElementById('detail-note').innerText = item.note || "（暫無備註）";
            const bk = document.getElementById('detail-booking-container');
            if(item.bookingRef) { bk.classList.remove('hidden'); document.getElementById('detail-bk-ref').innerText = item.bookingRef; document.getElementById('detail-bk-platform').innerText = item.bookingPlatform || '預約資訊'; } else bk.classList.add('hidden');
            document.getElementById('detail-modal').classList.remove('hidden');
        }
        function closeDetailModal() { document.getElementById('detail-modal').classList.add('hidden'); }
        function openExternalMap() { const i = state.currentItem; if(i.lat) window.open(`https://www.google.com/maps/search/?api=1&query=${i.lat},${i.lng}`); else window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(i.loc || i.title + " Fukuoka")}`); }
        function deleteFromDetail() { if(confirm("確定刪除此行程？")) { db.itinerary = db.itinerary.filter(i => i.id !== state.currentItem.id); save(); closeDetailModal(); } }

        // --- MAP ---
        function updateMap() {
            if(state.tab !== 'map') return;
            if(!map) { map = L.map('osm-map', { zoomControl: false }).setView(CONFIG.hotel.coords, 13); L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', { attribution: '' }).addTo(map); }
            map.invalidateSize();
            markers.forEach(m => map.removeLayer(m)); markers = [];
            const items = db.itinerary.filter(i => i.date === state.date && i.lat);
            L.marker(CONFIG.hotel.coords, {icon: L.divIcon({ html: '<div class="w-8 h-8 bg-black text-white rounded-full flex items-center justify-center shadow-lg border-2 border-white"><i class="fa-solid fa-bed"></i></div>', className: '' })}).addTo(map).bindPopup("<b>Home</b>");
            items.forEach(i => { const cat = CATS[i.type] || CATS.other; const c = cat.color.replace('text-', 'bg-').replace('600', '500'); const m = L.marker([i.lat, i.lng], {icon: L.divIcon({ html: `<div class="w-8 h-8 ${c} text-white rounded-full flex items-center justify-center shadow-lg border-2 border-white"><i class="fa-solid ${cat.icon} text-xs"></i></div>`, className: '' })}).addTo(map).bindPopup(i.title); markers.push(m); });
            document.getElementById('map-status').innerText = `顯示 ${items.length} 個地點`;
        }
        function refreshMap() { setTimeout(updateMap, 300); }

        // --- EXPENSES ---
        function renderExpenses() {
            const list = document.getElementById('expense-list');
            const items = db.expenses.filter(i => i.date === state.date);
            let totalF = 0, totalH = 0;
            list.innerHTML = items.map(i => {
                const amt = parseFloat(i.amount);
                if(i.curr === 'JPY') totalF += amt; else totalH += amt;
                return `<div class="bg-white px-4 py-3 rounded-2xl flex justify-between items-center shadow-sm border border-gray-50"><span class="text-jp-text font-bold">${i.desc}</span><div class="text-right"><div class="font-bold text-jp-text text-lg">${i.curr === 'JPY' ? '¥' : '$'} ${amt.toLocaleString()}</div><button onclick="deleteExpense(${i.id})" class="text-[10px] text-red-300">刪除</button></div></div>`;
            }).join('');
            document.getElementById('daily-total-foreign').innerText = totalF.toLocaleString();
            document.getElementById('daily-total-home').innerText = Math.round(totalF * CONFIG.rate + totalH).toLocaleString();
        }
        function deleteExpense(id) { db.expenses = db.expenses.filter(i => i.id !== id); save(); }

        // --- LISTS & INFO ---
        function openModal(type) {
            if(type === 'converter') { document.getElementById('modal-converter').classList.remove('hidden'); return; }
            if(type === 'safety') { document.getElementById('modal-safety').classList.remove('hidden'); return; }
            state.currentList = type;
            const config = { luggage: {t:'行李清單', i:'suitcase'}, shopping: {t:'購物清單', i:'bag-shopping'}, todo: {t:'待辦事項', i:'check-circle'} };
            const c = config[type];
            document.getElementById('generic-title').innerHTML = `<i class="fa-solid fa-${c.i} text-jp-accent"></i> ${c.t}`;
            renderGenericList();
            document.getElementById('modal-generic').classList.remove('hidden');
            toggleMainMenu();
        }
        function closeGenericModal() { document.getElementById('modal-generic').classList.add('hidden'); }
        function renderGenericList() {
            const type = state.currentList;
            const list = db[type] || [];
            document.getElementById('generic-list').innerHTML = list.map(i => `
                <li class="flex items-center gap-3 bg-white p-3 rounded-xl border border-gray-50 shadow-sm transition-all ${i.done ? 'opacity-50 grayscale' : ''}">
                    <div onclick="toggleItem('${type}', ${i.id})" class="w-6 h-6 rounded-full border-2 ${i.done ? 'bg-jp-accent border-jp-accent' : 'border-gray-300'} flex items-center justify-center text-white text-xs cursor-pointer"><i class="fa-solid fa-check ${i.done?'':'hidden'}"></i></div>
                    <span class="flex-1 font-medium ${i.done?'line-through':''}">${i.text}</span>
                    <button onclick="deleteListItem('${type}', ${i.id})" class="text-gray-300 px-2"><i class="fa-solid fa-xmark"></i></button>
                </li>
            `).join('');
        }
        function addGenericItem() { const inp = document.getElementById('generic-input'); if(!inp.value) return; if(!db[state.currentList]) db[state.currentList] = []; db[state.currentList].push({ id: Date.now(), text: inp.value, done: false }); inp.value = ''; save(); renderGenericList(); }
        function toggleItem(t, id) { const i = db[t].find(x=>x.id===id); if(i) i.done=!i.done; save(); renderGenericList(); }
        function deleteListItem(t, id) { db[t] = db[t].filter(x=>x.id!==id); save(); renderGenericList(); }
        function renderInfo() {
            document.getElementById('info-list').innerHTML = db.info.map(i => `
                <div class="bg-white p-5 rounded-2xl shadow-sm border-l-4 border-jp-accent relative">
                    <button onclick="deleteInfo(${i.id})" class="absolute top-4 right-4 text-gray-200"><i class="fa-solid fa-xmark"></i></button>
                    <h3 class="font-bold text-lg text-jp-text mb-2">${i.title}</h3>
                    <p class="text-sm text-gray-500 whitespace-pre-line leading-relaxed">${i.content}</p>
                </div>
            `).join('');
        }
        function deleteInfo(id) { if(confirm("刪除筆記？")) { db.info = db.info.filter(x=>x.id!==id); save(); } }

        // --- FORMS ---
        function openAddModal(type) {
            state.addType = type;
            document.getElementById('add-modal').classList.remove('hidden');
            const c = document.getElementById('modal-content');
            if(type === 'itinerary') {
                c.innerHTML = `
                    <div class="grid grid-cols-3 gap-3"><div class="bg-gray-50 p-2 rounded-xl border border-gray-100"><label class="text-[10px] text-gray-400 block mb-1">時間</label><input type="time" name="time" class="bg-transparent w-full font-bold outline-none" required></div><div class="col-span-2 bg-gray-50 p-2 rounded-xl border border-gray-100"><label class="text-[10px] text-gray-400 block mb-1">類型</label><select name="type" class="bg-transparent w-full font-bold outline-none">${Object.entries(CATS).map(([k,v])=>`<option value="${k}">${v.label}</option>`).join('')}</select></div></div>
                    <input type="text" name="title" placeholder="標題" class="w-full bg-gray-50 p-4 rounded-xl outline-none border border-gray-100 font-bold placeholder-gray-300" required>
                    <input type="text" name="loc" placeholder="地點 (選填)" class="w-full bg-gray-50 p-4 rounded-xl outline-none border border-gray-100 text-sm">
                    <div class="p-3 bg-orange-50 rounded-xl border border-orange-100"><div class="text-xs text-orange-400 font-bold mb-1">預約資訊</div><input type="text" name="bookingRef" placeholder="代號 / 備註" class="w-full bg-white p-2 rounded-lg text-sm outline-none"></div>
                    <textarea name="note" placeholder="備註..." class="w-full bg-gray-50 p-4 rounded-xl outline-none border border-gray-100 h-24 resize-none"></textarea>
                `;
            } else if (type === 'expense') {
                c.innerHTML = `<input type="text" name="desc" placeholder="項目" class="w-full bg-gray-50 p-4 rounded-xl font-bold outline-none" required><div class="flex gap-3"><input type="number" name="amount" placeholder="0" class="flex-1 bg-gray-50 p-4 rounded-xl font-bold text-xl outline-none" required><select name="curr" class="w-24 bg-jp-text text-white rounded-xl font-bold outline-none text-center"><option value="JPY">¥</option><option value="HKD">$</option></select></div>`;
            } else { c.innerHTML = `<input type="text" name="title" placeholder="標題" class="w-full bg-gray-50 p-4 rounded-xl font-bold outline-none" required><textarea name="content" placeholder="內容..." class="w-full bg-gray-50 p-4 rounded-xl outline-none h-32 mt-2 resize-none"></textarea>`; }
        }
        function closeAddModal() { document.getElementById('add-modal').classList.add('hidden'); }
        async function handleFormSubmit(e) {
            e.preventDefault(); const data = Object.fromEntries(new FormData(e.target)); data.id = Date.now();
            if(state.addType === 'itinerary') { data.date = state.date; if(data.loc) { try { const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(data.loc + " Fukuoka")}`); const r = await res.json(); if(r[0]) { data.lat = parseFloat(r[0].lat); data.lng = parseFloat(r[0].lon); } } catch(e){} } db.itinerary.push(data); }
            else if (state.addType === 'expense') { data.date = state.date; db.expenses.push(data); } else db.info.push(data);
            save(); closeAddModal();
        }

        // --- UTILS ---
        function toggleMainMenu() { const m = document.getElementById('main-menu'), o = document.getElementById('menu-overlay'); if(m.classList.contains('hidden')) { m.classList.remove('hidden'); o.classList.remove('hidden'); setTimeout(()=>m.classList.remove('opacity-0', 'scale-95'), 10); } else { m.classList.add('opacity-0', 'scale-95'); setTimeout(()=>m.classList.add('hidden'), 200); o.classList.add('hidden'); } }
        function switchTab(t) { state.tab = t; ['itinerary', 'map', 'finance', 'info'].forEach(x => document.getElementById(`view-${x}`).classList.add('hidden')); document.getElementById(`view-${t}`).classList.remove('hidden'); document.querySelectorAll('.nav-btn').forEach(b => { b.classList.remove('text-jp-accent', 'bg-jp-bg', 'shadow-sm', 'active'); b.classList.add('text-gray-300'); }); const btn = document.querySelector(`button[onclick="switchTab('${t}')"]`); btn.classList.remove('text-gray-300'); btn.classList.add('text-jp-accent', 'bg-jp-bg', 'shadow-sm', 'active'); if(t==='map') refreshMap(); }
        function openTaxiCard() { document.getElementById('modal-taxi').classList.remove('hidden'); }
        function closeModal(t) { document.getElementById(`modal-${t}`).classList.add('hidden'); }
        function convertCurrency(s) { const f = document.getElementById('conv-foreign'), h = document.getElementById('conv-home'); if(s==='foreign') h.value = (f.value * CONFIG.rate).toFixed(1); else f.value = (h.value / CONFIG.rate).toFixed(0); }
        function updateBadges() { const c = (db.shopping||[]).filter(i=>!i.done).length + (db.luggage||[]).filter(i=>!i.done).length; const el = document.getElementById('global-badge'); if(c>0) el.classList.remove('hidden'); else el.classList.add('hidden'); }
        function exportData() { const s = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(db)); const n = document.createElement('a'); n.setAttribute("href", s); n.setAttribute("download", `trip_backup_${new Date().toISOString().slice(0,10)}.json`); document.body.appendChild(n); n.click(); n.remove(); }
        function importData(i) { const f = i.files[0]; if(!f) return; const r = new FileReader(); r.onload = function(e) { try { db = JSON.parse(e.target.result); save(); alert("已還原！"); window.location.reload(); } catch(e) { alert("格式錯誤"); } }; r.readAsText(f); }
        async function fetchWeather() { try { const r = await fetch("https://api.open-meteo.com/v1/forecast?latitude=33.59&longitude=130.42&current_weather=true&timezone=Asia%2FTokyo"); const d = await r.json(); if(d.current_weather) { document.getElementById('weather-widget').classList.remove('hidden'); document.getElementById('weather-temp').innerText = `${Math.round(d.current_weather.temperature)}°C`; const c = d.current_weather.weathercode; let i = "fa-cloud", t = "陰天"; if(c <= 3) { i="fa-sun"; t="晴朗"; } else if(c >= 50) { i="fa-umbrella"; t="有雨"; } document.getElementById('weather-icon').innerHTML = `<i class="fa-solid ${i}"></i>`; document.getElementById('weather-desc').innerText = t; } } catch(e){} }

        init();
    </script>
</body>
</html>
