<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#FFFBF0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>ç¦å²¡ç™‚ç™’ä¹‹æ—…</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&family=Zen+Maru+Gothic:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'jp-bg': '#FFFBF0', 
                        'jp-card': '#FFFFFF',
                        'jp-text': '#4A4238', 
                        'jp-accent': '#C58945', 
                        'jp-blue-light': '#E0F2FE',
                    },
                    fontFamily: {
                        sans: ['Zen Maru Gothic', 'Noto Sans JP', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        body { -webkit-tap-highlight-color: transparent; overscroll-behavior-y: none; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .page-enter { animation: fadeIn 0.3s ease-out; }
        .modal-enter { animation: slideUp 0.25s cubic-bezier(0.2, 0.8, 0.2, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(100%); } to { opacity: 1; transform: translateY(0); } }
        .glass { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border-top: 1px solid rgba(0,0,0,0.05); }
        .siren-active { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both infinite; background-color: #EF4444 !important; color: white !important; border-color: #EF4444 !important; }
        @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }
        
        /* Layout Adjustments */
        .timeline-line { position: absolute; left: 3.5rem; top: 2.2rem; bottom: -1rem; width: 2px; background: #E5E7EB; z-index: 0; }
        .last-item .timeline-line { display: none; }
        
        .nav-btn.active { color: #C58945; transform: translateY(-2px); }
        .nav-btn.active::after { content: ''; position: absolute; bottom: -4px; width: 4px; height: 4px; background: #C58945; border-radius: 50%; }
        .weather-fade-in { animation: fadeIn 0.5s ease-in forwards; }
        
        /* Boarding Pass Style */
        .ticket-notch { position: absolute; width: 20px; height: 20px; background-color: #FFFBF0; border-radius: 50%; top: 50%; margin-top: -10px; z-index: 10; }
        .ticket-notch-l { left: -10px; }
        .ticket-notch-r { right: -10px; }
    </style>
</head>
<body class="bg-jp-bg text-jp-text h-[100dvh] w-full flex flex-col overflow-hidden font-sans select-none">

    <header class="px-5 pt-10 pb-2 flex justify-between items-center bg-jp-bg z-30 relative shrink-0">
        <div onclick="openTaxiCard()" class="cursor-pointer group">
            <h1 class="text-2xl font-bold tracking-widest text-jp-text flex items-center gap-2">
                ç¦å²¡ç™‚ç™’ä¹‹æ—… <i class="fa-solid fa-taxi text-xs text-white bg-jp-accent p-1.5 rounded-full shadow-sm group-active:scale-110 transition"></i>
            </h1>
        </div>
        
        <div class="flex gap-3">
            <button onclick="openTripInfo()" class="w-10 h-10 rounded-full bg-blue-50 text-blue-500 shadow-sm border border-blue-100 active:scale-95 transition flex items-center justify-center">
                <i class="fa-solid fa-circle-info text-base"></i>
            </button>
            <button onclick="openModal('safety')" class="w-10 h-10 rounded-full bg-red-50 text-red-500 shadow-sm border border-red-100 active:scale-95 transition flex items-center justify-center">
                <i class="fa-solid fa-shield-halved text-base"></i>
            </button>
            <button onclick="toggleMainMenu()" class="w-10 h-10 rounded-full bg-white shadow-sm active:scale-95 transition flex items-center justify-center border border-gray-100 relative">
                <i class="fa-solid fa-bars text-base text-jp-text"></i>
                <span id="global-badge" class="absolute top-0 right-0 w-2.5 h-2.5 bg-red-400 rounded-full border-2 border-white hidden"></span>
            </button>
        </div>

        <div id="main-menu" class="hidden absolute top-20 right-5 w-52 glass rounded-xl shadow-xl p-2 z-50 transform origin-top-right transition-all duration-200 border border-white/50">
            <button onclick="openModal('luggage')" class="w-full text-left px-4 py-3 rounded-lg hover:bg-white/60 flex items-center gap-3 transition text-base">
                <i class="fa-solid fa-suitcase text-purple-400 w-5 text-center"></i> è¡Œæ
                <span id="menu-badge-luggage" class="ml-auto text-xs bg-red-100 text-red-500 px-2 py-0.5 rounded-full hidden">0</span>
            </button>
            <button onclick="openModal('shopping')" class="w-full text-left px-4 py-3 rounded-lg hover:bg-white/60 flex items-center gap-3 transition text-base">
                <i class="fa-solid fa-bag-shopping text-pink-400 w-5 text-center"></i> è³¼ç‰©
                <span id="menu-badge-shop" class="ml-auto text-xs bg-red-100 text-red-500 px-2 py-0.5 rounded-full hidden">0</span>
            </button>
            <button onclick="openModal('todo')" class="w-full text-left px-4 py-3 rounded-lg hover:bg-white/60 flex items-center gap-3 transition text-base">
                <i class="fa-solid fa-check-circle text-blue-400 w-5 text-center"></i> å¾…è¾¦
            </button>
            <div class="my-1 border-t border-gray-100/50"></div>
            <button onclick="exportData()" class="w-full text-left px-4 py-3 rounded-lg hover:bg-white/60 flex items-center gap-3 transition text-sm text-gray-500">
                <i class="fa-solid fa-download w-5 text-center"></i> å‚™ä»½
            </button>
            <button onclick="document.getElementById('file-input').click()" class="w-full text-left px-4 py-3 rounded-lg hover:bg-white/60 flex items-center gap-3 transition text-sm text-gray-500">
                <i class="fa-solid fa-upload w-5 text-center"></i> é‚„åŸ
            </button>
            <input type="file" id="file-input" class="hidden" accept=".json" onchange="importData(this)">
        </div>
        <div id="menu-overlay" onclick="toggleMainMenu()" class="hidden fixed inset-0 z-40 bg-black/5"></div>
    </header>

    <div class="pl-5 py-2 bg-jp-bg z-10 shrink-0 border-b border-gray-100/50">
        <div id="date-slider" class="flex gap-3 overflow-x-auto no-scrollbar pr-5 pb-2"></div>
    </div>

    <main id="main-container" class="flex-1 overflow-y-auto bg-jp-bg relative scroll-smooth no-scrollbar">
        
        <div id="view-itinerary" class="page-enter pb-24 px-5 pt-4">
            <div id="weather-info-bar" class="text-xs text-gray-400 text-center mb-4 hidden bg-white/60 py-1.5 rounded-lg border border-white/50">
                <i class="fa-solid fa-clock-rotate-left mr-1"></i> é¡¯ç¤º 2024å¹´åŒæœŸæ­·å²å¤©æ°£ä¾›åƒè€ƒ
            </div>
            <div id="itinerary-list" class="space-y-0 relative"></div>
            
            <button onclick="openAddModal('itinerary')" class="mt-8 w-full py-4 rounded-2xl border-2 border-dashed border-jp-accent/30 text-jp-accent text-base font-bold hover:bg-white transition flex justify-center items-center gap-2 group">
                <i class="fa-solid fa-plus text-sm group-hover:scale-110 transition"></i> æ–°å¢è¡Œç¨‹
            </button>
        </div>

        <div id="view-map" class="hidden h-full flex flex-col page-enter px-2 pb-20 pt-2">
            <div class="bg-white/90 backdrop-blur-sm p-3 rounded-xl shadow-sm mb-3 text-sm flex gap-2 items-center justify-between z-10 absolute top-4 left-4 right-4 border border-white">
                <div class="flex items-center gap-2 text-gray-500 truncate">
                    <i class="fa-solid fa-location-dot text-red-400"></i>
                    <span id="map-status">è¼‰å…¥ä¸­...</span>
                </div>
                <button onclick="refreshMap()" class="text-blue-500 bg-blue-50 px-3 py-1.5 rounded-full font-bold whitespace-nowrap text-xs">é‡æ•´</button>
            </div>
            <div id="osm-map" class="flex-1 w-full rounded-2xl overflow-hidden shadow-inner bg-gray-100 z-0"></div>
        </div>

        <div id="view-finance" class="hidden page-enter px-5 pt-4 pb-24 space-y-5">
            <div class="bg-gray-800 rounded-3xl p-6 text-white shadow-xl shadow-gray-300 relative overflow-hidden">
                <div class="absolute -right-6 -top-6 w-32 h-32 bg-white/10 rounded-full blur-2xl"></div>
                <div class="text-xs text-white/60 mb-1">æœ¬æ—¥æ”¯å‡º (JPY)</div>
                <div class="flex items-baseline gap-2">
                    <span class="text-2xl font-bold font-mono text-jp-accent">Â¥</span>
                    <span class="text-5xl font-bold font-mono tracking-tight" id="daily-total-foreign">0</span>
                </div>
                <div class="mt-4 pt-4 border-t border-white/10 text-sm text-white/60 flex justify-between items-center">
                    <span class="font-mono">â‰ˆ HKD <span id="daily-total-home">0</span></span>
                    <button onclick="openAddModal('expense')" class="bg-white text-gray-800 px-4 py-1.5 rounded-full text-xs font-bold shadow-sm active:scale-95 transition">
                        <i class="fa-solid fa-plus mr-1"></i> è¨˜ä¸€ç­†
                    </button>
                </div>
            </div>
            <div id="expense-list" class="space-y-3"></div>
        </div>

        <div id="view-info" class="hidden page-enter px-5 pt-4 pb-24 space-y-4">
             <div class="flex justify-between items-center mb-2">
                <h2 class="text-lg font-bold text-jp-text border-l-4 border-jp-accent pl-3">æ—…äººç­†è¨˜</h2>
                <button onclick="openAddModal('info')" class="text-jp-accent w-8 h-8 flex items-center justify-center bg-white rounded-full shadow-sm border border-gray-100"><i class="fa-solid fa-plus text-sm"></i></button>
            </div>
            <div id="info-list" class="grid grid-cols-1 gap-4"></div>
        </div>
    </main>

    <nav class="fixed bottom-0 left-0 right-0 w-full glass z-40 flex justify-around items-end px-2 pb-6 pt-3 rounded-t-[2rem] shadow-[0_-5px_20px_rgba(0,0,0,0.03)]">
        <button onclick="switchTab('itinerary')" class="nav-btn active flex flex-col items-center gap-1 w-16 transition-all duration-300">
            <i class="fa-solid fa-calendar-day text-xl"></i>
            <span class="text-[10px] font-bold">è¡Œç¨‹</span>
        </button>
        <button onclick="switchTab('map')" class="nav-btn text-gray-300 flex flex-col items-center gap-1 w-16 transition-all duration-300">
            <i class="fa-solid fa-map text-xl"></i>
            <span class="text-[10px] font-bold">åœ°åœ–</span>
        </button>
        <button onclick="switchTab('finance')" class="nav-btn text-gray-300 flex flex-col items-center gap-1 w-16 transition-all duration-300">
            <i class="fa-solid fa-wallet text-xl"></i>
            <span class="text-[10px] font-bold">è¨˜å¸³</span>
        </button>
        <button onclick="openModal('converter')" class="nav-btn text-gray-300 flex flex-col items-center gap-1 w-16 transition-all duration-300">
            <i class="fa-solid fa-calculator text-xl"></i>
            <span class="text-[10px] font-bold">æ›ç®—</span>
        </button>
    </nav>

    <div id="modal-trip-info" class="fixed inset-0 bg-black/40 backdrop-blur-sm z-[60] hidden flex flex-col justify-end">
        <div class="bg-jp-bg w-full rounded-t-[2.5rem] p-6 pb-12 modal-enter max-h-[90vh] overflow-y-auto no-scrollbar shadow-2xl">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold flex items-center gap-2 text-jp-text"><i class="fa-solid fa-circle-info text-blue-500"></i> æ—…ç¨‹è³‡è¨Š</h2>
                <button onclick="closeModal('trip-info')" class="w-9 h-9 flex items-center justify-center bg-gray-100 rounded-full text-gray-400"><i class="fa-solid fa-xmark"></i></button>
            </div>

            <div class="bg-white rounded-3xl p-6 shadow-sm border border-gray-100 mb-6 relative overflow-hidden">
                <div class="absolute right-0 top-0 bg-yellow-100 text-yellow-700 text-xs font-bold px-3 py-1.5 rounded-bl-xl">ä½å®¿</div>
                <h3 class="font-bold text-jp-text text-xl leading-tight mb-1">Hotel Wing International</h3>
                <p class="text-sm text-gray-500 mb-4">Hakata Shinkansenguchi (åšå¤šæ–°å¹¹ç·šå£)</p>
                
                <div class="bg-gray-50 rounded-2xl p-4 border border-gray-100 mb-4">
                    <div class="flex items-start gap-2 mb-3">
                        <i class="fa-solid fa-location-dot text-jp-accent mt-1 text-sm"></i>
                        <p id="hotel-address" class="text-sm text-gray-600 leading-relaxed flex-1">ç¦å²¡å¸‚åšå¤šåŒºåšå¤šé§…æ±1-17-17<br><span class="text-xs text-gray-400">(å¾åšå¤šç«™ç­‘ç´«å£æ­¥è¡Œ4åˆ†é˜ï¼Œå…¥å£åœ¨ç­‘ç´«å£æ±å´ï¼Œæ²¿åšå¤šé§…æ±è¡—ç›´èµ°)</span></p>
                        <button onclick="copyText('hotel-address')" class="text-gray-400 hover:text-jp-accent p-1"><i class="fa-regular fa-copy text-lg"></i></button>
                    </div>
                    <a href="https://www.hotelwing.co.jp/hakata-shinkansen/" target="_blank" class="w-full bg-white border border-blue-200 text-blue-500 font-bold py-2 rounded-xl text-center text-xs block hover:bg-blue-50 transition">é–‹å•Ÿå®˜ç¶² / åœ°åœ–</a>
                </div>

                <div class="grid grid-cols-2 gap-4 text-center">
                    <div class="bg-blue-50 rounded-xl p-3">
                        <div class="text-[10px] text-blue-400 font-bold uppercase mb-1">Check-in</div>
                        <div class="text-lg font-bold text-blue-600 font-mono">15:00</div>
                    </div>
                    <div class="bg-orange-50 rounded-xl p-3">
                        <div class="text-[10px] text-orange-400 font-bold uppercase mb-1">Check-out</div>
                        <div class="text-lg font-bold text-orange-600 font-mono">11:00</div>
                    </div>
                </div>
            </div>

            <div class="space-y-4">
                <h3 class="text-base font-bold text-gray-400 pl-2">èˆªç­è³‡è¨Š</h3>
                
                <div class="bg-white rounded-3xl p-0 shadow-sm border border-gray-100 relative overflow-hidden">
                    <div class="ticket-notch ticket-notch-l"></div>
                    <div class="ticket-notch ticket-notch-r"></div>
                    <div class="p-5 pb-3 flex justify-between items-center bg-gray-50/50">
                        <div class="text-xs font-bold bg-sky-100 text-sky-600 px-3 py-1 rounded-full">å»ç¨‹</div>
                        <div class="text-base font-bold text-gray-800 font-mono tracking-wider">UO638</div>
                        <div class="text-xs text-gray-400 font-bold">2026/02/14 (å…­)</div>
                    </div>
                    <div class="px-6 py-5 flex justify-between items-center text-center">
                        <div>
                            <div class="text-3xl font-bold text-jp-text font-mono">HKG</div>
                            <div class="text-sm text-gray-500 font-mono font-bold mt-1">12:50</div>
                        </div>
                        <div class="text-gray-300 text-sm flex flex-col items-center">
                            <i class="fa-solid fa-plane text-sky-300 mb-1"></i>
                            <div class="border-t-2 border-dashed border-gray-200 w-16"></div>
                            <span class="text-[10px] mt-1 text-gray-400">3h 20m</span>
                        </div>
                        <div>
                            <div class="text-3xl font-bold text-jp-text font-mono">FUK</div>
                            <div class="text-sm text-gray-500 font-mono font-bold mt-1">17:10</div>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-3xl p-0 shadow-sm border border-gray-100 relative overflow-hidden">
                    <div class="ticket-notch ticket-notch-l"></div>
                    <div class="ticket-notch ticket-notch-r"></div>
                    <div class="p-5 pb-3 flex justify-between items-center bg-gray-50/50">
                        <div class="text-xs font-bold bg-pink-100 text-pink-600 px-3 py-1 rounded-full">å›ç¨‹</div>
                        <div class="text-base font-bold text-gray-800 font-mono tracking-wider">UO669</div>
                        <div class="text-xs text-gray-400 font-bold">2026/02/20 (äº”)</div>
                    </div>
                    <div class="px-6 py-5 flex justify-between items-center text-center">
                        <div>
                            <div class="text-3xl font-bold text-jp-text font-mono">FUK</div>
                            <div class="text-sm text-gray-500 font-mono font-bold mt-1">16:05</div>
                        </div>
                        <div class="text-gray-300 text-sm flex flex-col items-center">
                            <i class="fa-solid fa-plane fa-rotate-180 text-pink-300 mb-1"></i>
                            <div class="border-t-2 border-dashed border-gray-200 w-16"></div>
                            <span class="text-[10px] mt-1 text-gray-400">3h 10m</span>
                        </div>
                        <div>
                            <div class="text-3xl font-bold text-jp-text font-mono">HKG</div>
                            <div class="text-sm text-gray-500 font-mono font-bold mt-1">19:15</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="detail-modal" class="fixed inset-0 bg-black/40 backdrop-blur-md z-50 hidden flex items-end sm:items-center justify-center">
        <div class="bg-white w-full sm:w-[480px] rounded-t-[2.5rem] sm:rounded-[2.5rem] p-8 pb-10 modal-enter relative max-h-[85vh] overflow-y-auto no-scrollbar shadow-2xl">
            <div class="w-12 h-1.5 bg-gray-200 rounded-full mx-auto mb-8"></div>
            
            <div class="flex items-start gap-5 mb-8">
                <div id="detail-icon-bg" class="w-16 h-16 rounded-2xl flex-shrink-0 flex items-center justify-center text-3xl shadow-md text-white ring-4 ring-white">
                    <i id="detail-icon" class="fa-solid"></i>
                </div>
                <div class="flex-1">
                    <div id="detail-time" class="text-jp-accent text-sm font-bold font-mono mb-1 bg-orange-50 inline-block px-2 py-0.5 rounded-lg border border-orange-100"></div>
                    <h2 id="detail-title" class="text-2xl font-bold text-jp-text leading-tight mb-2 mt-1"></h2>
                    <div id="detail-loc-wrapper" class="text-sm text-gray-500 flex items-start gap-2 cursor-pointer hover:text-blue-600 transition group" onclick="copyAddress()">
                        <i class="fa-solid fa-location-dot mt-1 text-red-400 group-hover:text-blue-500"></i>
                        <span id="detail-loc" class="leading-snug"></span>
                        <i class="fa-regular fa-copy ml-1 opacity-30 group-hover:opacity-100 mt-1"></i>
                    </div>
                </div>
            </div>
            
            <div class="grid grid-cols-2 gap-4 mb-8">
                <a id="btn-map" href="#" class="col-span-1 py-4 bg-white text-blue-600 rounded-2xl flex items-center justify-center gap-2 text-sm font-bold active:scale-95 transition border-2 border-blue-100 hover:bg-blue-50 shadow-sm">
                    <i class="fa-solid fa-map-location-dot text-lg"></i> Google Maps
                </a>
                <a id="btn-app-action" href="#" class="col-span-1 py-4 bg-white text-orange-600 rounded-2xl flex items-center justify-center gap-2 text-sm font-bold active:scale-95 transition border-2 border-orange-100 hover:bg-orange-50 shadow-sm hidden">
                    <i class="fa-solid fa-utensils text-lg"></i> Tabelog
                </a>
                <a id="btn-booking" href="#" class="col-span-2 py-4 bg-gray-800 text-white rounded-2xl flex items-center justify-center gap-2 text-sm font-bold shadow-lg active:scale-95 transition hidden hover:bg-gray-700">
                    <i class="fa-solid fa-ticket text-lg"></i> é–‹å•Ÿé è¨‚ / æ†‘è­‰ <span id="booking-ref-display" class="font-mono bg-white/20 px-2 py-0.5 rounded text-xs ml-1"></span>
                </a>
            </div>

            <div class="bg-jp-bg p-6 rounded-3xl border border-gray-100 mb-8 shadow-inner">
                <div class="text-xs text-gray-400 mb-3 font-bold uppercase tracking-wider flex justify-between items-center">
                    <span><i class="fa-solid fa-circle-info mr-1"></i> è©³ç´°æ”»ç•¥ & ç­†è¨˜</span>
                    <i class="fa-solid fa-pen text-gray-300 cursor-pointer p-2 hover:bg-white rounded-full"></i>
                </div>
                <div id="detail-note" class="text-base text-gray-700 leading-relaxed whitespace-pre-line font-medium"></div>
            </div>

            <div class="flex gap-4">
                <button onclick="closeDetailModal()" class="flex-1 py-4 text-gray-500 text-base font-bold rounded-2xl bg-gray-100 hover:bg-gray-200 transition">é—œé–‰</button>
                <button onclick="deleteFromDetail()" class="flex-1 py-4 text-red-500 text-base font-bold rounded-2xl bg-red-50 hover:bg-red-100 transition"><i class="fa-solid fa-trash-can mr-2"></i> åˆªé™¤</button>
            </div>
        </div>
    </div>

    <div id="modal-safety" class="fixed inset-0 bg-red-50/95 backdrop-blur-sm z-[60] hidden flex flex-col justify-end">
        <div class="bg-white w-full rounded-t-[2.5rem] p-8 pb-12 modal-enter shadow-[0_-10px_60px_rgba(239,68,68,0.2)]">
            <div class="flex justify-between items-center mb-8">
                <h2 class="text-xl font-bold flex items-center gap-3 text-red-500"><i class="fa-solid fa-shield-heart text-2xl"></i> å®‰å…¨å®ˆè­·</h2>
                <button onclick="closeModal('safety')" class="w-10 h-10 flex items-center justify-center bg-gray-50 rounded-full text-gray-400"><i class="fa-solid fa-xmark text-lg"></i></button>
            </div>
            <button id="siren-btn" onclick="toggleSiren()" class="w-full py-8 bg-white border-4 border-red-100 rounded-3xl flex flex-col items-center justify-center text-red-500 font-bold mb-6 shadow-sm active:scale-[0.98] transition">
                <i class="fa-solid fa-bullhorn text-4xl mb-3"></i>
                <span id="siren-text" class="text-lg">å•Ÿå‹•é˜²ç‹¼è­¦å ±</span>
            </button>
            <div class="grid grid-cols-2 gap-4 mb-6">
                <button onclick="sendWhatsAppSOS()" class="bg-[#25D366] text-white py-5 rounded-2xl font-bold flex flex-col items-center justify-center gap-1 shadow-lg shadow-green-100 active:scale-95 transition">
                    <i class="fa-brands fa-whatsapp text-3xl"></i> <span class="text-sm">ç™¼é€å®šä½</span>
                </button>
                <div class="bg-gray-50 p-4 rounded-2xl border border-gray-100">
                    <label class="text-xs text-gray-400 font-bold block mb-2">ç·Šæ€¥è¯çµ¡äºº</label>
                    <div class="flex gap-1">
                        <input type="tel" id="safety-contact" class="w-full bg-white px-3 py-2 rounded-xl text-base outline-none border border-gray-200" placeholder="é›»è©±è™Ÿç¢¼" onchange="saveContact()">
                    </div>
                </div>
            </div>
            <div class="grid grid-cols-3 gap-4">
                <button onclick="openNearby('police')" class="text-sm font-bold py-4 bg-blue-50 text-blue-500 rounded-2xl hover:bg-blue-100 transition"><i class="fa-solid fa-building-shield mb-2 block text-xl"></i>æ´¾å‡ºæ‰€</button>
                <button onclick="openNearby('hospital')" class="text-sm font-bold py-4 bg-red-50 text-red-500 rounded-2xl hover:bg-red-100 transition"><i class="fa-solid fa-hospital mb-2 block text-xl"></i>é†«é™¢</button>
                <button onclick="openNearby('convenience_store')" class="text-sm font-bold py-4 bg-orange-50 text-orange-500 rounded-2xl hover:bg-orange-100 transition"><i class="fa-solid fa-store mb-2 block text-xl"></i>ä¾¿åˆ©åº—</button>
            </div>
        </div>
    </div>

    <div id="modal-taxi" class="fixed inset-0 bg-jp-text z-[70] hidden flex flex-col items-center justify-center p-6 text-center page-enter" onclick="closeModal('taxi')">
        <div class="bg-white text-black p-10 rounded-2xl w-full max-w-sm shadow-2xl transform rotate-1">
            <h2 class="text-3xl font-bold mb-6 border-b-4 border-black pb-4">ãƒ›ãƒ†ãƒ«ã¸ãŠé¡˜ã„ã—ã¾ã™</h2>
            <p class="text-2xl font-bold mb-6 leading-snug">Hotel Wing International<br>Hakata Shinkansenguchi</p>
            <p class="text-2xl font-bold bg-yellow-100 p-4 rounded-xl leading-relaxed select-all">ç¦å²¡å¸‚åšå¤šåŒºåšå¤šé§…æ±<br>1-17-17</p>
        </div>
        <div class="mt-10 text-white/50 text-sm">é»æ“Šä»»æ„è™•é—œé–‰</div>
    </div>

    <div id="modal-converter" class="fixed inset-0 bg-black/40 backdrop-blur-sm z-50 hidden flex items-center justify-center px-6">
        <div class="bg-white w-full max-w-xs rounded-[2rem] p-8 page-enter shadow-2xl relative">
            <button onclick="closeModal('converter')" class="absolute top-5 right-5 w-8 h-8 flex items-center justify-center bg-gray-50 rounded-full text-gray-300"><i class="fa-solid fa-xmark"></i></button>
            <h3 class="font-bold mb-6 text-jp-text text-center text-lg">åŒ¯ç‡æ›ç®—</h3>
            <div class="space-y-4">
                <div class="bg-gray-50 rounded-2xl p-4 border border-gray-100 flex items-center"><span class="text-gray-400 text-xs font-bold mr-3 w-8">JPY</span><input type="number" id="conv-foreign" class="bg-transparent text-3xl font-bold w-full outline-none text-jp-text font-mono" placeholder="0" oninput="convertCurrency('foreign')"></div>
                <div class="flex justify-center -my-6 relative z-10"><i class="fa-solid fa-arrow-down-up text-gray-300 text-sm bg-white p-2 rounded-full border border-gray-100 shadow-sm"></i></div>
                <div class="bg-gray-50 rounded-2xl p-4 border border-gray-100 flex items-center"><span class="text-gray-400 text-xs font-bold mr-3 w-8">HKD</span><input type="number" id="conv-home" class="bg-transparent text-3xl font-bold w-full outline-none text-gray-500 font-mono" placeholder="0" oninput="convertCurrency('home')"></div>
            </div>
        </div>
    </div>

    <div id="modal-generic" class="fixed inset-0 bg-black/30 backdrop-blur-sm z-50 hidden flex justify-end">
        <div class="bg-jp-bg w-full max-w-md h-full shadow-2xl flex flex-col modal-enter rounded-l-[2rem] overflow-hidden">
            <div class="p-6 bg-white flex justify-between items-center shadow-sm z-10">
                <h2 id="generic-title" class="text-xl font-bold flex items-center gap-3 text-jp-text">æ¸…å–®</h2>
                <button onclick="closeGenericModal()" class="w-10 h-10 flex items-center justify-center bg-gray-50 rounded-full text-gray-400"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="p-4 bg-gray-50 border-b border-gray-100 flex gap-3">
                <input type="text" id="generic-input" class="flex-1 bg-white rounded-xl px-4 py-3 outline-none text-base shadow-sm border border-gray-200" placeholder="æ–°å¢é …ç›®...">
                <button onclick="addGenericItem()" class="bg-jp-text text-white w-12 rounded-xl shadow-sm"><i class="fa-solid fa-plus"></i></button>
            </div>
            <ul id="generic-list" class="flex-1 overflow-y-auto p-6 space-y-3 pb-12"></ul>
        </div>
    </div>

    <div id="add-modal" class="fixed inset-0 bg-black/40 backdrop-blur-sm z-50 hidden flex items-end sm:items-center justify-center">
        <div class="bg-white w-full sm:w-[500px] rounded-t-[2rem] sm:rounded-[2rem] p-8 pb-10 page-enter relative">
            <div class="flex justify-between items-center mb-6">
                <h3 class="font-bold text-xl text-jp-text">æ–°å¢é …ç›®</h3>
                <button onclick="closeAddModal()" class="w-10 h-10 bg-gray-50 rounded-full text-gray-300"><i class="fa-solid fa-xmark text-lg"></i></button>
            </div>
            <form id="add-form" onsubmit="handleFormSubmit(event)" class="space-y-4">
                <div id="modal-content"></div>
                <button type="submit" class="w-full bg-jp-text text-white font-bold py-4 rounded-2xl shadow-lg mt-6 active:scale-[0.98] transition text-base">ç¢ºèªå„²å­˜</button>
            </form>
        </div>
    </div>

    <script>
        // CONFIG
        const CONFIG = {
            key: "fukuoka_trip_2026_final_v8_rich_content",
            dates: ["2026-02-14", "2026-02-15", "2026-02-16", "2026-02-17", "2026-02-18", "2026-02-19", "2026-02-20"],
            rate: 0.052,
            hotel: { name: "Hotel Wing International", coords: [33.5910, 130.4225] },
            defaultItinerary: [
                // Day 1
                { id: 101, date: "2026-02-14", time: "17:10", type: "flight", title: "æŠµé”ç¦å²¡æ©Ÿå ´ (UO638)", loc: "Fukuoka Airport", lat: 33.5859, lng: 130.4446, bookingRef: "UO638", note: "ã€äº¤é€šæŒ‡ç¤ºã€‘\n1. å…¥å¢ƒå¾Œç›´èµ°ç´„50ç±³ï¼Œå‰å¾€ã€Œ2è™Ÿå·´å£«ä¹˜è»Šè™•ã€(å³æ‰‹é‚Š)ã€‚\n2. æ­ä¹˜ã€Œè¥¿éµå·´å£« (å¾€åšå¤šé§…ãƒ»å¤©ç¥æ–¹å‘)ã€ã€‚\n3. åœ¨ã€Œåšå¤šé§…ç­‘ç´«å£ã€ä¸‹è»Š (ç´„ç¬¬3ç«™)ã€‚\nè²»ç”¨ï¼šÂ¥310 (ICå¡/ç¾é‡‘)ã€‚æ™‚é–“ï¼šç´„20åˆ†é˜ã€‚\nâš ï¸ å¦‚æœè¿·è·¯ï¼Œå•å·¥ä½œäººå“¡ 'Bus to Hakata Station?'" },
                { id: 102, date: "2026-02-14", time: "18:20", type: "other", title: "Check-in", loc: "Hotel Wing International", lat: 33.5910, lng: 130.4225, link: "https://www.hotelwing.co.jp/hakata-shinkansen/", note: "åœ°å€ï¼šç¦å²¡å¸‚åšå¤šåŒºåšå¤šé§…æ±1-17-17\nã€æ­¥è¡ŒæŒ‡å¼•ã€‘\nä¸‹è»Šå¾Œï¼Œå…¥å£åœ¨ç­‘ç´«å£æ±å´ï¼Œæ²¿è‘—åšå¤šé§…æ±è¡—ç›´èµ°ï¼Œéä¸€å€‹å°è·¯å£å¾Œå³æ‰‹é‚Šå³è¦‹é£¯åº—æ‹›ç‰Œ (ç´„4åˆ†é˜)ã€‚" },
                { id: 103, date: "2026-02-14", time: "18:45", type: "shopping", title: "ä½å‰é…’è²© (è§’æ‰“é«”é©—)", loc: "åšå¤š Deitos Annex 1F", lat: 33.5905, lng: 130.4195, note: "ã€äº¤é€šã€‘å¾é£¯åº—èµ°å›åšå¤šç«™ç­‘ç´«å£ï¼Œé€²ç«™å¾Œè·Ÿéš¨ 'Deitos Annex' æ¨™èªŒï¼Œç›´èµ°100ç±³å·¦æ‰‹é‚Šã€‚\n\nã€é«”é©—ã€‘æ›è³¼ã€ŒèŠ±æœ­ã€ä»£å¹£ (Â¥500èµ·) å…Œæ›é…’èˆ‡å°èœã€‚\nğŸ’¡ç´€å¿µå“ï¼šä¹å·é™å®šæ¸…é…’ç“¶ã€‚" },
                { id: 104, date: "2026-02-14", time: "19:30", type: "food", title: "åšå¤šç‰›è…¸é‹ é£¯å±±", loc: "åšå¤š Deitos 1F", lat: 33.5905, lng: 130.4195, link: "https://resy.com/cities/fukuoka-japan/venues/hakata-motsunabe-ooyama-deitos-hakata", note: "ã€äº¤é€šã€‘å¾ä½å‰é…’è²©å‡ºä¾†ï¼Œæ²¿å•†å ´èµ°50ç±³ï¼Œå³æ‰‹é‚Šã€Œåšå¤šéºµè¡—é“ã€ä¸‹æ¨“æ¢¯ã€‚\n\nğŸ½ï¸ å¿…é»ï¼šå‘³å™Œç‰›è…¸é‹ã€ç”Ÿå•¤é…’ã€‚\nğŸ’° é ç®—ï¼šÂ¥2,500ã€‚" },
                { id: 105, date: "2026-02-14", time: "21:00", type: "food", title: "èŒ¶é…’æ²™é¾ Yorozu", loc: "èµ¤å‚2-3-32", lat: 33.5865, lng: 130.3940, bookingRef: "å·²é ç´„", link: "https://autoreserve.com/zh-tw/restaurants/QrFYAjJWeRj4e6cev4nr", note: "ã€äº¤é€šã€‘åœ°éµç©ºæ¸¯ç·šã€Œèµ¤å‚ç«™ã€2è™Ÿå‡ºå£ï¼Œå‡ºç«™å·¦è½‰ç›´èµ°300ç±³ã€‚\n\nğŸ½ï¸ å¿…é»ï¼šèŒ¶é…’å¥—é¤ (Tea Cocktail Course)ã€‚\nğŸ’° é ç®—ï¼šÂ¥5,000ã€‚" },
                
                // Day 2
                { id: 201, date: "2026-02-15", time: "08:30", type: "food", title: "åšå¤šç‰›èˆŒæ—©é¤ Tandoya", loc: "åšå¤šä¸€ç•ªè¡— B1", lat: 33.5898, lng: 130.4200, note: "ã€äº¤é€šã€‘åšå¤šç«™ç­‘ç´«å£é€²ç«™ï¼Œè·Ÿéš¨ã€Œåšå¤šä¸€ç•ªè¡—ã€æ¨™èªŒä¸‹æ¨“åˆ°B1ã€‚\n\nğŸ½ï¸ å¿…é»ï¼šç‰›èˆŒæ—©é¤å®šé£Ÿ (Â¥800)ã€‚" },
                { id: 202, date: "2026-02-15", time: "09:30", type: "transport", title: "å‰å¾€åŸå³¶é…’è—é–‹å€‰", loc: "JRåšå¤šç«™ -> è’æœ¨ç«™", note: "è·¯ç·šï¼šJRé¹¿å…’å³¶æœ¬ç·š (å¿«é€Ÿ) -> ã€Œè’æœ¨ç«™ã€ (ç´„30åˆ†, Â¥1,130)ã€‚\nè½‰ä¹˜ï¼šå‡ºç«™å³æ‰‹é‚Šæ­å…è²»æ¥é§å·´å£«è‡³æœƒå ´ã€‚" },
                { id: 203, date: "2026-02-15", time: "11:00", type: "sightseeing", title: "åŸå³¶é…’è—é–‹å€‰ç¥­", loc: "åŸå³¶ç”ºæ°‘ä¹‹æ£®å…¬åœ’", lat: 33.2750, lng: 130.4700, link: "https://welcome-kurume.com/tw/events/detail/aafc88d1-e520-4a74-849f-a2f54b58a68f", note: "ã€æ”»ç•¥ã€‘ä¸»æœƒå ´è²·è©¦é£²åˆ¸ï¼Œæ­å·¡è¿´å·´å£«è‡³é…’é€  (æ¨è–¦: æ¯”ç¿¼é¶´é…’é€ )ã€‚\nğŸ½ï¸ å¿…åƒï¼šé°»é­šè’¸ç± é£¯ã€‚\nğŸ’¡ç´€å¿µå“ï¼šé™é‡æ–°é…’ç“¶ã€‚" },
                { id: 204, date: "2026-02-15", time: "16:30", type: "shopping", title: "LOPIA è¶…å¸‚ åšå¤šåº—", loc: "Yodobashi Camera 4F", lat: 33.5885, lng: 130.4220, note: "ã€äº¤é€šã€‘åšå¤šç«™ç­‘ç´«å£å³è½‰èµ°100ç±³è‡³Yodobashiï¼Œé›»æ¢¯ä¸Š4Fã€‚\nâš ï¸ æ³¨æ„ï¼šåªæ”¶ç¾é‡‘ï¼è«‹æº–å‚™è¶³å¤ ç¾é‡‘ã€‚" },
                { id: 205, date: "2026-02-15", time: "18:30", type: "food", title: "åšå¤šé›çš®å¤§è‡£", loc: "KITTE åšå¤š B1", lat: 33.5890, lng: 130.4185, note: "ã€äº¤é€šã€‘åšå¤šç«™åšå¤šå£å·¦å´ KITTE å¤§æ¨“ B1ã€‚\nğŸ½ï¸ å¿…é»ï¼šé†¬æ±é›çš®ã€Highballã€‚" },

                // Day 3
                { id: 301, date: "2026-02-16", time: "08:45", type: "food", title: "il FORNO del MIGNON", loc: "åšå¤šç«™ä¸­å¤®æ”¹æœ­å£", lat: 33.5900, lng: 130.4205, note: "å¿…è²·ï¼šç¾çƒ¤è¿·ä½ å¯é Œï¼Œé…é£¯åº—å’–å•¡ã€‚\nğŸ’° é ç®—ï¼šÂ¥500ã€‚" },
                { id: 302, date: "2026-02-16", time: "09:30", type: "transport", title: "å·´å£«å‰å¾€å¤ªå®°åºœ", loc: "åšå¤šå·´å£«ç¸½ç«™ 11è™Ÿæœˆå°", note: "ã€åœ°é»ã€‘åšå¤šå£å·¦å´å·´å£«ç¸½ç«™ 1Fã€‚\nè·¯ç·šï¼šæ­ä¹˜ã€Œæ—…äººè™Ÿ (Tabito)ã€ å·´å£« (Â¥610ï¼ŒICå¡å¯)ã€‚" },
                { id: 303, date: "2026-02-16", time: "10:30", type: "sightseeing", title: "å¤ªå®°åºœå¤©æ»¿å®® & ç«ˆé–€ç¥ç¤¾", loc: "å¤ªå®°åºœå¸‚", lat: 33.5215, lng: 130.5349, note: "ã€ç«ˆé–€ç¥ç¤¾äº¤é€šã€‘è¥¿éµå¤ªå®°åºœç«™å‰æ­ç¤¾å€å·´å£«ã€ŒMahorobaã€(å…§å±±ç·š) (Â¥100)ã€‚\nğŸ’¡ç´€å¿µå“ï¼šå¤©æ»¿å®®å¾¡å®ˆã€ç·£çµã³å®ˆã€‚" },
                { id: 304, date: "2026-02-16", time: "12:30", type: "food", title: "èŒ¶å’Œã€… (Sawawa)", loc: "å¤ªå®°åºœåƒé“", lat: 33.5200, lng: 130.5335, note: "ğŸ½ï¸ å¿…åƒï¼šæ¥µæ¿ƒæŠ¹èŒ¶é›ªç³• (Â¥800)ã€‚" },
                { id: 305, date: "2026-02-16", time: "14:30", type: "other", title: "äºŒæ—¥å¸‚æº«æ³‰ã€Œåšå¤šæ¹¯ã€", loc: "äºŒæ—¥å¸‚", lat: 33.4930, lng: 130.5250, note: "ã€äº¤é€šã€‘è¥¿éµäºŒæ—¥å¸‚ç«™è¥¿å£å‡ºï¼Œå³è½‰æ²¿æ¹¯ç”ºè¡—èµ°12åˆ†ã€‚\nè²»ç”¨ï¼šå…¥æµ´æ–™Â¥350ï¼Œæ¯›å·¾Â¥200ã€‚\nå¤æ¹¯æ”¾é¬†é«”é©—ã€‚" },
                { id: 306, date: "2026-02-16", time: "19:00", type: "food", title: "æ—­è»’ é§…å‰æœ¬åº—", loc: "åšå¤šé§…å‰2-15-22", lat: 33.5905, lng: 130.4170, note: "ğŸ½ï¸ å¿…é»ï¼šä¸€å£ç…é¤ƒã€ç‚¸é›ç¿…ã€‚\nğŸ’° é ç®—ï¼šÂ¥1,500ã€‚" },

                // Day 4
                { id: 401, date: "2026-02-17", time: "08:15", type: "food", title: "å› å¹¡çƒé¾éºµ", loc: "åšå¤š Deitos 1F éºµè¡—é“", lat: 33.5905, lng: 130.4195, note: "ğŸ½ï¸ å¿…é»ï¼šç‰›è’¡å¤©å©¦ç¾…çƒé¾éºµã€‚" },
                { id: 402, date: "2026-02-17", time: "09:00", type: "transport", title: "å‰å¾€éº’éºŸå•¤é…’å·¥å» ", loc: "ç”˜æœ¨éµé“ å¤ªåˆ€æ´—ç«™", note: "è·¯ç·šï¼šJRåˆ°ã€ŒåŸºå±±ç«™ã€ -> è½‰ä¹˜ç”˜æœ¨éµé“è‡³ã€Œå¤ªåˆ€æ´—ç«™ã€ã€‚\nâš ï¸ ç”˜æœ¨éµé“åªæ”¶ç¾é‡‘ (Â¥330)ï¼Œè«‹å‚™é›¶éŒ¢ã€‚" },
                { id: 403, date: "2026-02-17", time: "10:30", type: "sightseeing", title: "éº’éºŸå•¤é…’ç¦å²¡å·¥å» ", loc: "æœå€‰å¸‚é¦¬ç”°3601", lat: 33.3900, lng: 130.6100, bookingRef: "éœ€é ç´„", link: "https://kirinfactory.my.salesforce-sites.com/ensp/WebSelectEnSp", note: "è²»ç”¨ï¼šÂ¥500 (å«è¦‹å­¸+è©¦é£²)ã€‚éœ€é ç´„ã€‚\nğŸ’¡ç´€å¿µå“ï¼šå•¤é…’æ¯ã€‚" },
                { id: 404, date: "2026-02-17", time: "12:00", type: "food", title: "Kirin Beer Farm", loc: "å·¥å» åœ’å€å…§", lat: 33.3900, lng: 130.6100, note: "ğŸ½ï¸ å¿…åƒï¼šæˆå‰æ€æ±—çƒ¤è‚‰ (ç¾Šè‚‰)ã€‚" },
                { id: 405, date: "2026-02-17", time: "15:00", type: "sightseeing", title: "å—è—é™¢ (æ¶…æ§ƒä½›)", loc: "ç¯ æ —ç”º", lat: 33.6190, lng: 130.5730, note: "ã€äº¤é€šã€‘å¤ªåˆ€æ´— -> åŸºå±± -> JRåšå¤š (è½‰ç¯ æ —ç·š) -> åŸæˆ¶å—è—é™¢å‰ç«™ã€‚\nä¸–ç•Œæœ€å¤§é’éŠ…é‡‹è¿¦æ¶…æ§ƒä½›ã€‚åƒæ‹œè²»Â¥300ã€‚" },
                { id: 406, date: "2026-02-17", time: "18:30", type: "food", title: "æµ·é¢¨åœŸ (Seafood)", loc: "åšå¤šé§…æ±2-4-17", lat: 33.5908, lng: 130.4230, note: "ã€äº¤é€šã€‘åšå¤šç«™ç­‘ç´«å£å³è½‰ï¼Œæ²¿åšå¤šé§…æ±è¡—èµ°200ç±³ï¼Œéè·¯å£å·¦æ‰‹é‚Šã€‚\nğŸ½ï¸ å¿…é»ï¼šæµ·ä¹‹å¯¶ç®±ç”Ÿé­šç‰‡(500å††)ã€èƒ¡éº»é¯–é­šã€‚" },

                // Day 5
                { id: 501, date: "2026-02-18", time: "07:30", type: "food", title: "æ±ç­‘è»’ é›è‚‰é£¯ä¾¿ç•¶", loc: "åšå¤šç«™ä¸­å¤®æ”¹æœ­å£", lat: 33.5900, lng: 130.4205, note: "å¿…è²·ï¼šæ±ç­‘è»’ ã‹ã—ã‚ã‚ã— (Â¥1,000)ã€‚è»Šä¸Šäº«ç”¨ã€‚" },
                { id: 502, date: "2026-02-18", time: "08:00", type: "transport", title: "ç‰¹æ€¥ Sonic å¾€åˆ¥åºœ", loc: "JRåšå¤šç«™", bookingRef: "Sonic", note: "è»Šç¨‹ç´„2å°æ™‚ã€‚è«‹äº‹å…ˆè²·ç¥¨æˆ–ç”¨ICå¡ (Â¥4,000èµ·)ã€‚" },
                { id: 503, date: "2026-02-18", time: "10:20", type: "sightseeing", title: "å¤§åˆ†é¦™æ°´åšç‰©é¤¨", loc: "åˆ¥åºœå¸‚åŒ—çŸ³å£48-1", lat: 33.3080, lng: 131.4900, note: "ã€äº¤é€šã€‘åˆ¥åºœç«™è¥¿å£æ­é¾œä¹‹äº•å·´å£«(2/5/7/41è™Ÿ)è‡³ã€Œåˆ¥åºœå¤§å­¸ä¸‹ã€ã€‚\nèª¿é¦™é«”é©— Â¥2,500ã€‚" },
                { id: 504, date: "2026-02-18", time: "13:00", type: "food", title: "Beppu Brewery", loc: "åˆ¥åºœç«™å‰", lat: 33.2790, lng: 131.5000, note: "ã€äº¤é€šã€‘åˆ¥åºœç«™å‰å·¦è½‰æ²¿é§…å‰è¡—èµ°5åˆ†ã€‚\nğŸ½ï¸ å¿…é»ï¼šå•¤é…’è©¦é£²çµ„ã€ç‚¸é›å¤©å©¦ç¾…ã€‚" },
                { id: 505, date: "2026-02-18", time: "15:00", type: "other", title: "ç«¹ç“¦æº«æ³‰ (ç ‚æ¹¯)", loc: "åˆ¥åºœå¸‚å…ƒç”º16-23", lat: 33.2780, lng: 131.5050, note: "ã€äº¤é€šã€‘æ²¿å…ƒç”ºè¡—ç›´èµ°10åˆ†ã€‚\né«”é©—ï¼šç†±ç ‚æ’æ¯’ã€‚è²»ç”¨ Â¥1,500 (å«æµ´è¡£)ã€‚" },
                { id: 506, date: "2026-02-18", time: "19:30", type: "food", title: "åšå¤šä¸€é›™ æ‹‰éºµ", loc: "åšå¤šé§…æ±3-1-6", lat: 33.5895, lng: 130.4250, note: "ã€äº¤é€šã€‘åšå¤šç«™ç­‘ç´«å£å³è½‰ï¼Œæ²¿æ±3è¡—èµ°5åˆ†ã€‚\nğŸ½ï¸ å¿…é»ï¼šç³–å¿ƒè›‹æ‹‰éºµ (å‘³ç‰ãƒ©ãƒ¼ãƒ¡ãƒ³)ã€‚" },

                // Day 6
                { id: 601, date: "2026-02-19", time: "09:30", type: "transport", title: "å‰å¾€æ˜å¤ªå­å·¥åŠ", loc: "JRåšå¤šç«™ -> å‰å¡šç«™", note: "JRé¹¿å…’å³¶æœ¬ç·š (1ç«™, Â¥200)ï¼Œæ±å£å‡ºç«™èµ°13åˆ†é˜ã€‚" },
                { id: 602, date: "2026-02-19", time: "10:00", type: "sightseeing", title: "Haku Haku æ˜å¤ªå­æ‰‹ä½œ", loc: "å‰å¡š", lat: 33.6080, lng: 130.4280, bookingRef: "éœ€é ç´„", link: "https://www.hakuhaku.com/workshop/", note: "è²»ç”¨ï¼šç´„Â¥2,200ã€‚\nå…§å®¹ï¼šèª¿è£½å°ˆå±¬æ˜å¤ªå­ã€‚" },
                { id: 603, date: "2026-02-19", time: "11:45", type: "shopping", title: "å¸‚å·é¦™èˆ– (ç·šé¦™)", loc: "ä¸­æ´²å·ç«¯å•†åº—è¡—", lat: 33.5930, lng: 130.4080, note: "ã€äº¤é€šã€‘å‰å¡šå›åšå¤š -> åœ°éµã€Œä¸­æ´²å·ç«¯ç«™ã€5è™Ÿå‡ºå£ã€‚\næŒ‘é¸æ—¥æœ¬è£½é«˜ç´šç·šé¦™ï¼ˆç™½æª€/æ²ˆé¦™ï¼‰ã€‚" },
                { id: 604, date: "2026-02-19", time: "12:30", type: "food", title: "ç‡’è‚‰ BAKURO å¤§ååº—", loc: "å¤§å", lat: 33.5875, lng: 130.3950, note: "ã€äº¤é€šã€‘åœ°éµã€Œèµ¤å‚ç«™ã€å‡ºç«™èµ°5åˆ†ã€‚\nğŸ½ï¸ å¿…é»ï¼šåˆé–“ç‡’è‚‰å¥—é¤ (CPå€¼é«˜)ã€‚" },
                { id: 605, date: "2026-02-19", time: "14:00", type: "shopping", title: "AEON Shoppers ç¦å²¡åº—", loc: "å¤©ç¥", lat: 33.5920, lng: 130.3980, note: "ã€äº¤é€šã€‘æ²¿å¤©ç¥è¡—ç›´èµ°10-12åˆ†ã€‚\nå¤§å‹è¶…å¸‚ï¼Œå¯é€€ç¨…ã€‚" },
                { id: 606, date: "2026-02-19", time: "16:30", type: "sightseeing", title: "MY ONLY FRAGRANCE", loc: "å¤§å1-1-35", lat: 33.5860, lng: 130.3960, bookingRef: "éœ€é ç´„", link: "https://myonlyfragrance.com/reservation/", note: "è£½ä½œå°ˆå±¬é¦™æ°´é«”é©—ã€‚\né ç®—ï¼šÂ¥5,000èµ·ã€‚" },
                { id: 607, date: "2026-02-19", time: "18:00", type: "food", title: "Fukuoka Craft Brewing", loc: "å¤§å1-11-4", lat: 33.5865, lng: 130.3955, note: "å·¥è—å•¤é…’å§ï¼Œè©¦é£²é«”é©—ã€‚" },
                { id: 608, date: "2026-02-19", time: "19:00", type: "food", title: "çƒé¾éºµ å’ŒåŠ©", loc: "å¤©ç¥", lat: 33.5900, lng: 130.3990, note: "ğŸ½ï¸ å¿…é»ï¼šç‰›è’¡å¤©å©¦ç¾…çƒé¾éºµã€‚" },

                // Day 7
                { id: 701, date: "2026-02-20", time: "10:00", type: "food", title: "Nana's Green Tea", loc: "JRåšå¤šåŸ Amu Plaza", lat: 33.5898, lng: 130.4207, note: "Check-outå¾Œå¯„æ”¾è¡Œæã€‚\nğŸ½ï¸ å¿…åƒï¼šæŠ¹èŒ¶ç”Ÿå·§å…‹åŠ›èŠ­è²ã€‚" },
                { id: 702, date: "2026-02-20", time: "11:00", type: "sightseeing", title: "çŸ³è—é…’é€  åšå¤šç™¾å¹´è—", loc: "åšå¤šåŒºå …ç²•1-30-1", lat: 33.6020, lng: 130.4220, link: "https://www.ishikura-shuzou.co.jp/", note: "ã€äº¤é€šã€‘åšå¤šå£å·¦è½‰æ²¿å …ç²•è¡—ç›´èµ°20åˆ† (æˆ–æ­å·´å£«)ã€‚\nå…è²»åƒè§€ï¼Œè©¦é£²Â¥300èµ·ã€‚" },
                { id: 703, date: "2026-02-20", time: "12:15", type: "food", title: "é®¨ å‰²çƒ¹ ã‚„ã¾ä¸­", loc: "JRåšå¤šåŸ 9F", lat: 33.5898, lng: 130.4207, bookingRef: "å‹™å¿…é ç´„", link: "https://tabelog.com/en/fukuoka/A4001/A400101/40026334/", note: "ğŸ½ï¸ å¿…åƒï¼šç‰¹é¸æ¡å£½å¸å¥—é¤ã€‚\nğŸ’° é ç®—ï¼šÂ¥4,000-Â¥6,000ã€‚\nâš ï¸ å‹™å¿…é ç´„ 12:15ã€‚" },
                { id: 704, date: "2026-02-20", time: "14:00", type: "transport", title: "å‰å¾€æ©Ÿå ´", loc: "åšå¤šå·´å£«ç¸½ç«™ 11è™Ÿæœˆå°", note: "æ­ä¹˜ã€Œç¦å²¡æ©Ÿå ´åœ‹éš›ç·š ç›´é”å·´å£«ã€(Â¥310)ã€‚" },
                { id: 705, date: "2026-02-20", time: "14:30", type: "flight", title: "æŠµé”æ©Ÿå ´ (UO669)", loc: "Fukuoka Airport", bookingRef: "UO669", note: "è¾¦ç†ç™»æ©Ÿï¼Œèµ·é£›æ™‚é–“ 16:05ã€‚" }
            ]
        };

        const CATS = {
            sightseeing: { label: "æ™¯é»", icon: "fa-camera", color: "text-green-600", bg: "bg-green-100" },
            transport: { label: "äº¤é€š", icon: "fa-train-subway", color: "text-blue-600", bg: "bg-blue-100" },
            flight: { label: "èˆªç­", icon: "fa-plane-up", color: "text-sky-600", bg: "bg-sky-100" },
            food: { label: "ç¾é£Ÿ", icon: "fa-utensils", color: "text-orange-600", bg: "bg-orange-100" },
            shopping: { label: "è³¼ç‰©", icon: "fa-bag-shopping", color: "text-pink-600", bg: "bg-pink-100" },
            other: { label: "å…¶ä»–", icon: "fa-star", color: "text-purple-600", bg: "bg-purple-100" }
        };

        let db = { itinerary: [], expenses: [], shopping: [], todo: [], luggage: [], info: [], settings: { safetyContact: "" } };
        let state = { date: CONFIG.dates[0], tab: 'itinerary', currentList: null, currentItem: null };
        let map = null, markers = [];
        let weatherCache = {}; 

        // --- INIT ---
        function init() {
            const saved = localStorage.getItem(CONFIG.key);
            if (saved) db = JSON.parse(saved);
            else {
                db.itinerary = CONFIG.defaultItinerary;
                db.luggage = ["ICå¡", "ç¾é‡‘", "è­·ç…§", "ç¶²å¡", "å……é›»å™¨", "é˜²ç‹¼è­¦å ±"].map((t,i)=>({id:i, text:t, done:false}));
            }
            if(!db.settings) db.settings = { safetyContact: "" };
            if(db.settings.safetyContact) document.getElementById('safety-contact').value = db.settings.safetyContact;

            renderDateSlider();
            renderAll();
            document.getElementById('rate-display').innerText = CONFIG.rate;
            fetchDailyWeather(state.date);
        }

        function save() { localStorage.setItem(CONFIG.key, JSON.stringify(db)); renderAll(); }
        function renderAll() { renderItinerary(); renderExpenses(); renderInfo(); updateBadges(); }

        // --- RENDER ITINERARY ---
        function renderDateSlider() {
            const el = document.getElementById('date-slider');
            el.innerHTML = CONFIG.dates.map(d => {
                const dateObj = new Date(d);
                const day = dateObj.getDate();
                const week = dateObj.toLocaleDateString('zh-HK',{weekday:'short'});
                const active = d === state.date ? "bg-jp-text text-white shadow-md scale-105" : "bg-white text-gray-400 border border-gray-100";
                return `<button onclick="setDate('${d}')" class="flex-shrink-0 flex flex-col items-center justify-center w-12 h-14 rounded-xl transition-all duration-200 ${active}">
                    <span class="text-[9px] opacity-80">${week}</span><span class="text-lg font-bold font-mono leading-none">${day}</span>
                </button>`;
            }).join('');
        }
        function setDate(d) { 
            state.date = d; 
            renderDateSlider(); 
            renderItinerary(); 
            renderExpenses(); 
            updateMap();
            fetchDailyWeather(d);
        }

        function renderItinerary() {
            const list = document.getElementById('itinerary-list');
            const items = db.itinerary.filter(i => i.date === state.date).sort((a,b) => a.time.localeCompare(b.time));
            
            if(items.length === 0) { list.innerHTML = `<div class="text-center py-20 opacity-30"><i class="fa-solid fa-mug-hot text-4xl mb-2"></i><div class="text-xs">æœ¬æ—¥ç„¡è¡Œç¨‹</div></div>`; return; }

            list.innerHTML = items.map((i, index) => {
                const cat = CATS[i.type] || CATS.other;
                const isLast = index === items.length - 1 ? 'last-item' : '';
                return `
                <div onclick="openDetail(${i.id})" class="relative pl-20 py-2.5 group cursor-pointer ${isLast}">
                    <div class="timeline-line"></div>
                    
                    <div class="absolute left-0 top-3 w-14 text-right">
                        <div class="text-sm font-bold font-mono text-gray-500">${i.time}</div>
                    </div>

                    <div class="absolute left-[4.3rem] top-3.5 w-4 h-4 rounded-full border-2 border-white ${cat.bg} z-10 shadow-sm flex items-center justify-center">
                        <div class="w-1.5 h-1.5 rounded-full ${cat.color.replace('text-', 'bg-')}"></div>
                    </div>

                    <div class="bg-white rounded-2xl p-4 shadow-[0_2px_8px_rgba(0,0,0,0.03)] border border-transparent hover:border-gray-200 transition active:scale-[0.99] flex justify-between items-center gap-3">
                        <div class="flex-1 min-w-0">
                            <h3 class="font-bold text-jp-text text-lg truncate leading-tight mb-1">${i.title}</h3>
                            <div class="flex items-center gap-2 text-xs text-gray-400">
                                <span class="truncate max-w-[140px]"><i class="fa-solid fa-location-dot mr-1 opacity-60"></i>${i.loc || 'æœªè¨­å®š'}</span>
                                ${i.bookingRef ? `<span class="bg-blue-50 text-blue-500 px-1.5 py-0.5 rounded flex-shrink-0 font-mono text-[10px]">${i.bookingRef}</span>` : ''}
                            </div>
                        </div>
                        
                        <div id="weather-${i.id}" class="flex flex-col items-end justify-center w-14 border-l border-gray-100 pl-3 min-h-[40px] text-gray-300">
                             <div class="w-2 h-2 bg-gray-100 rounded-full animate-pulse"></div>
                        </div>
                    </div>
                </div>`;
            }).join('');
            
            if(weatherCache[state.date]) updateWeatherUI(state.date);
        }

        // --- WEATHER SYSTEM ---
        async function fetchDailyWeather(dateStr) {
            if(weatherCache[dateStr]) { updateWeatherUI(dateStr); return; }

            const targetDate = new Date(dateStr);
            const now = new Date();
            const diffDays = Math.ceil((targetDate - now) / (1000 * 60 * 60 * 24));
            
            const lat = 33.59, lng = 130.42;
            let url = "", isHistorical = false;
            const params = "&hourly=temperature_2m,weathercode,relative_humidity_2m&timezone=Asia%2FTokyo";

            if (diffDays > 10) {
                isHistorical = true;
                const refDate = dateStr.replace('2026', '2024'); 
                url = `https://archive-api.open-meteo.com/v1/archive?latitude=${lat}&longitude=${lng}&start_date=${refDate}&end_date=${refDate}${params}`;
            } else {
                url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lng}&start_date=${dateStr}&end_date=${dateStr}${params}`;
            }

            try {
                const res = await fetch(url);
                const data = await res.json();
                
                if(data.hourly) {
                    weatherCache[dateStr] = {
                        isHistorical: isHistorical,
                        hourly: data.hourly
                    };
                    updateWeatherUI(dateStr);
                }
            } catch(e) { console.error("Weather fetch failed", e); }
        }

        function updateWeatherUI(dateStr) {
            if (dateStr !== state.date) return;
            const data = weatherCache[dateStr];
            if (!data) return;

            const notice = document.getElementById('weather-info-bar');
            if(data.isHistorical) notice.classList.remove('hidden'); else notice.classList.add('hidden');

            const items = db.itinerary.filter(i => i.date === state.date);
            items.forEach(i => {
                const el = document.getElementById(`weather-${i.id}`);
                if (!el) return;

                const hour = parseInt(i.time.split(':')[0]);
                if (isNaN(hour)) return;

                const temp = Math.round(data.hourly.temperature_2m[hour]);
                const code = data.hourly.weathercode[hour];
                const humid = data.hourly.relative_humidity_2m ? Math.round(data.hourly.relative_humidity_2m[hour]) : '--';
                
                let icon = "fa-cloud", color = "text-gray-400";
                
                if (code === 0) { icon = "fa-sun"; color = "text-orange-400"; }
                else if (code <= 3) { icon = "fa-cloud-sun"; color = "text-orange-300"; }
                else if (code >= 45 && code <= 48) { icon = "fa-smog"; color = "text-gray-400"; }
                else if (code >= 51 && code <= 67) { icon = "fa-cloud-rain"; color = "text-blue-400"; }
                else if (code >= 71 && code <= 77) { icon = "fa-snowflake"; color = "text-sky-300"; }
                else if (code >= 80) { icon = "fa-cloud-bolt"; color = "text-purple-400"; }

                el.innerHTML = `
                    <i class="fa-solid ${icon} ${color} text-lg mb-0.5 weather-fade-in"></i>
                    <span class="text-xs font-bold text-jp-text leading-none mb-0.5">${temp}Â°C</span>
                    <span class="text-[9px] text-gray-400 font-mono leading-none"><i class="fa-solid fa-droplet text-[8px] mr-0.5 opacity-70"></i>${humid}%</span>
                `;
            });
        }

        // --- MODAL FUNCTIONS ---
        function openTripInfo() { document.getElementById('modal-trip-info').classList.remove('hidden'); }

        function openDetail(id) {
            const item = db.itinerary.find(i => i.id === id);
            if(!item) return;
            state.currentItem = item;
            const cat = CATS[item.type] || CATS.other;

            document.getElementById('detail-title').innerText = item.title;
            document.getElementById('detail-time').innerText = `${item.date} Â· ${item.time}`;
            document.getElementById('detail-icon').className = `fa-solid ${cat.icon}`;
            document.getElementById('detail-icon-bg').className = `w-14 h-14 rounded-2xl flex-shrink-0 flex items-center justify-center text-2xl shadow-sm text-white ${cat.color.replace('text-', 'bg-')}`;
            document.getElementById('detail-loc').innerText = item.loc || "æœªè¨­å®šåœ°é»";
            document.getElementById('detail-note').innerText = item.note || "ï¼ˆç„¡å‚™è¨»ï¼‰";

            const mapBtn = document.getElementById('btn-map');
            const query = item.loc || item.title;
            const latLng = item.lat ? `${item.lat},${item.lng}` : null;
            mapBtn.href = latLng ? `https://www.google.com/maps/search/?api=1&query=${latLng}` : `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(query + " Fukuoka")}`;

            const appBtn = document.getElementById('btn-app-action');
            if (item.type === 'food') {
                appBtn.classList.remove('hidden');
                appBtn.innerHTML = '<i class="fa-solid fa-utensils"></i> Tabelog';
                appBtn.className = "col-span-1 py-3 bg-orange-50 text-orange-600 rounded-xl flex items-center justify-center gap-2 text-xs font-bold active:scale-95 transition border border-orange-100";
                appBtn.href = item.link && item.link.includes('tabelog') ? item.link : `https://tabelog.com/rstLst/?vs=1&sa=&sk=${encodeURIComponent(item.title)}`;
            } else if (item.type === 'sightseeing' || item.type === 'other') {
                appBtn.classList.remove('hidden');
                appBtn.innerHTML = '<i class="fa-solid fa-ticket"></i> KKday';
                appBtn.className = "col-span-1 py-3 bg-teal-50 text-teal-600 rounded-xl flex items-center justify-center gap-2 text-xs font-bold active:scale-95 transition border border-teal-100";
                appBtn.href = `https://www.kkday.com/zh-hk/product/product_list?keyword=${encodeURIComponent(item.title)}`;
            } else {
                appBtn.classList.add('hidden');
            }

            const bkBtn = document.getElementById('btn-booking');
            if (item.bookingRef || (item.link && !item.link.includes('tabelog'))) {
                bkBtn.classList.remove('hidden');
                bkBtn.className = appBtn.classList.contains('hidden') ? "col-span-2 py-3 bg-gray-800 text-white rounded-xl flex items-center justify-center gap-2 text-xs font-bold shadow-md active:scale-95 transition" : "col-span-2 py-3 bg-gray-800 text-white rounded-xl flex items-center justify-center gap-2 text-xs font-bold shadow-md active:scale-95 transition mt-0";
                document.getElementById('booking-ref-display').innerText = item.bookingRef || "";
                bkBtn.href = item.link || "#";
            } else {
                bkBtn.classList.add('hidden');
            }

            document.getElementById('detail-modal').classList.remove('hidden');
        }

        function copyAddress() {
            const txt = document.getElementById('detail-loc').innerText;
            if(txt) { navigator.clipboard.writeText(txt); alert("åœ°å€å·²è¤‡è£½"); }
        }
        function copyText(id) {
            const txt = document.getElementById(id).innerText;
            if(txt) { navigator.clipboard.writeText(txt); alert("è¤‡è£½æˆåŠŸï¼"); }
        }
        function closeModal(t) { document.getElementById(`modal-${t}`).classList.add('hidden'); }
        function deleteFromDetail() { if(confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) { db.itinerary = db.itinerary.filter(i => i.id !== state.currentItem.id); save(); closeDetailModal(); } }

        // --- MAP LOGIC ---
        function updateMap() {
            if(state.tab !== 'map') return;
            if(!map) { map = L.map('osm-map', { zoomControl: false }).setView(CONFIG.hotel.coords, 13); L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', { attribution: '' }).addTo(map); }
            map.invalidateSize();
            markers.forEach(m => map.removeLayer(m)); markers = [];
            const items = db.itinerary.filter(i => i.date === state.date && i.lat);
            
            L.marker(CONFIG.hotel.coords, {icon: L.divIcon({ html: '<div class="w-8 h-8 bg-gray-800 text-white rounded-full flex items-center justify-center shadow-lg border-2 border-white text-xs"><i class="fa-solid fa-bed"></i></div>', className: '' })}).addTo(map).bindPopup("Hotel");
            
            items.forEach(i => { 
                const cat = CATS[i.type] || CATS.other; 
                const bg = cat.color.replace('text-', 'bg-');
                const m = L.marker([i.lat, i.lng], {icon: L.divIcon({ html: `<div class="w-8 h-8 ${bg} text-white rounded-full flex items-center justify-center shadow-lg border-2 border-white text-xs"><i class="fa-solid ${cat.icon}"></i></div>`, className: '' })}).addTo(map).bindPopup(i.title); 
                markers.push(m); 
            });
            
            if(items.length > 0) {
                 const group = new L.featureGroup([L.marker(CONFIG.hotel.coords), ...markers]);
                 map.fitBounds(group.getBounds().pad(0.15));
            }
        }
        function refreshMap() { setTimeout(updateMap, 300); }

        // --- EXPENSES ---
        function renderExpenses() {
            const list = document.getElementById('expense-list');
            const items = db.expenses.filter(i => i.date === state.date);
            let totalF = 0;
            list.innerHTML = items.map(i => {
                const amt = parseFloat(i.amount);
                if(i.curr === 'JPY') totalF += amt; 
                return `<div class="bg-white px-4 py-3 rounded-xl flex justify-between items-center shadow-sm border border-gray-50"><span class="text-sm font-bold text-jp-text">${i.desc}</span><div class="flex items-center gap-3"><span class="font-bold text-jp-text font-mono">Â¥ ${amt.toLocaleString()}</span><button onclick="deleteExpense(${i.id})" class="text-gray-300 hover:text-red-400"><i class="fa-solid fa-xmark"></i></button></div></div>`;
            }).join('');
            document.getElementById('daily-total-foreign').innerText = totalF.toLocaleString();
            document.getElementById('daily-total-home').innerText = Math.round(totalF * CONFIG.rate).toLocaleString();
        }
        function deleteExpense(id) { db.expenses = db.expenses.filter(i => i.id !== id); save(); }

        // --- INFO & LISTS ---
        function renderInfo() {
            document.getElementById('info-list').innerHTML = db.info.map(i => `
                <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 relative">
                    <button onclick="deleteInfo(${i.id})" class="absolute top-3 right-3 text-gray-200"><i class="fa-solid fa-xmark"></i></button>
                    <h3 class="font-bold text-sm text-jp-text mb-1">${i.title}</h3>
                    <p class="text-xs text-gray-500 whitespace-pre-line">${i.content}</p>
                </div>`).join('');
        }
        function deleteInfo(id) { if(confirm("åˆªé™¤ç­†è¨˜ï¼Ÿ")) { db.info = db.info.filter(x=>x.id!==id); save(); } }
        
        function openModal(type) {
            if(type === 'converter') { document.getElementById('modal-converter').classList.remove('hidden'); return; }
            if(type === 'safety') { document.getElementById('modal-safety').classList.remove('hidden'); return; }
            state.currentList = type;
            const config = { luggage: {t:'è¡Œæ', i:'suitcase'}, shopping: {t:'è³¼ç‰©', i:'bag-shopping'}, todo: {t:'å¾…è¾¦', i:'check-circle'} };
            document.getElementById('generic-title').innerHTML = `<i class="fa-solid fa-${config[type].i} text-jp-accent"></i> ${config[type].t}`;
            renderGenericList();
            document.getElementById('modal-generic').classList.remove('hidden');
            document.getElementById('main-menu').classList.add('hidden'); document.getElementById('menu-overlay').classList.add('hidden');
        }
        function renderGenericList() {
            const type = state.currentList;
            const list = db[type] || [];
            document.getElementById('generic-list').innerHTML = list.map(i => `
                <li class="flex items-center gap-3 bg-white p-3 rounded-lg border border-gray-100 shadow-sm ${i.done ? 'opacity-50' : ''}">
                    <div onclick="toggleItem('${type}', ${i.id})" class="w-5 h-5 rounded-full border-2 ${i.done ? 'bg-jp-accent border-jp-accent' : 'border-gray-300'} flex items-center justify-center text-white text-[10px] cursor-pointer"><i class="fa-solid fa-check ${i.done?'':'hidden'}"></i></div>
                    <span class="flex-1 text-sm font-medium ${i.done?'line-through':''}">${i.text}</span>
                    <button onclick="deleteListItem('${type}', ${i.id})" class="text-gray-300 px-2"><i class="fa-solid fa-xmark"></i></button>
                </li>`).join('');
        }
        function addGenericItem() { const inp = document.getElementById('generic-input'); if(!inp.value) return; if(!db[state.currentList]) db[state.currentList] = []; db[state.currentList].push({ id: Date.now(), text: inp.value, done: false }); inp.value = ''; save(); renderGenericList(); }
        function toggleItem(t, id) { const i = db[t].find(x=>x.id===id); if(i) i.done=!i.done; save(); renderGenericList(); }
        function deleteListItem(t, id) { db[t] = db[t].filter(x=>x.id!==id); save(); renderGenericList(); }
        function closeGenericModal() { document.getElementById('modal-generic').classList.add('hidden'); }

        // --- FORMS & SAFETY ---
        function openAddModal(type) {
            state.addType = type;
            document.getElementById('add-modal').classList.remove('hidden');
            const c = document.getElementById('modal-content');
            if(type === 'itinerary') {
                c.innerHTML = `
                    <div class="grid grid-cols-3 gap-2"><div class="bg-gray-50 p-2 rounded-xl border border-gray-100"><label class="text-[9px] text-gray-400 block">æ™‚é–“</label><input type="time" name="time" class="bg-transparent w-full font-bold outline-none text-sm" required></div><div class="col-span-2 bg-gray-50 p-2 rounded-xl border border-gray-100"><label class="text-[9px] text-gray-400 block">é¡å‹</label><select name="type" class="bg-transparent w-full font-bold outline-none text-sm">${Object.entries(CATS).map(([k,v])=>`<option value="${k}">${v.label}</option>`).join('')}</select></div></div>
                    <input type="text" name="title" placeholder="æ¨™é¡Œ" class="w-full bg-gray-50 p-3 rounded-xl outline-none border border-gray-100 font-bold text-sm" required>
                    <input type="text" name="loc" placeholder="åœ°é»" class="w-full bg-gray-50 p-3 rounded-xl outline-none border border-gray-100 text-sm">
                    <input type="text" name="bookingRef" placeholder="é ç´„ä»£è™Ÿ / å‚™è¨»" class="w-full bg-blue-50/50 p-3 rounded-xl text-sm outline-none text-blue-800 placeholder-blue-300">
                    <textarea name="note" placeholder="å‚™è¨»..." class="w-full bg-gray-50 p-3 rounded-xl outline-none border border-gray-100 h-20 text-sm resize-none"></textarea>
                    <input type="url" name="link" placeholder="ç¶²å€ (é¸å¡«)" class="w-full bg-gray-50 p-3 rounded-xl outline-none border border-gray-100 text-sm">`;
            } else if (type === 'expense') {
                c.innerHTML = `<input type="text" name="desc" placeholder="é …ç›®" class="w-full bg-gray-50 p-3 rounded-xl font-bold outline-none text-sm" required><div class="flex gap-2"><input type="number" name="amount" placeholder="0" class="flex-1 bg-gray-50 p-3 rounded-xl font-bold text-lg outline-none" required><select name="curr" class="w-20 bg-jp-text text-white rounded-xl font-bold outline-none text-center text-sm"><option value="JPY">Â¥</option><option value="HKD">$</option></select></div>`;
            } else {
                 c.innerHTML = `<input type="text" name="title" placeholder="æ¨™é¡Œ" class="w-full bg-gray-50 p-3 rounded-xl font-bold outline-none text-sm" required><textarea name="content" placeholder="å…§å®¹..." class="w-full bg-gray-50 p-3 rounded-xl outline-none h-24 mt-2 resize-none text-sm"></textarea>`;
            }
        }
        function closeAddModal() { document.getElementById('add-modal').classList.add('hidden'); }
        async function handleFormSubmit(e) {
            e.preventDefault(); const data = Object.fromEntries(new FormData(e.target)); data.id = Date.now();
            if(state.addType === 'itinerary') { data.date = state.date; if(data.loc) { try { const r = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(data.loc + " Fukuoka")}`); const j = await r.json(); if(j[0]) { data.lat = parseFloat(j[0].lat); data.lng = parseFloat(j[0].lon); } } catch(e){} } db.itinerary.push(data); }
            else if (state.addType === 'expense') { data.date = state.date; db.expenses.push(data); } else db.info.push(data);
            save(); closeAddModal();
        }

        // --- UTILS ---
        function toggleMainMenu() { const m = document.getElementById('main-menu'), o = document.getElementById('menu-overlay'); if(m.classList.contains('hidden')) { m.classList.remove('hidden'); o.classList.remove('hidden'); } else { m.classList.add('hidden'); o.classList.add('hidden'); } }
        function switchTab(t) { state.tab = t; ['itinerary', 'map', 'finance', 'info'].forEach(x => document.getElementById(`view-${x}`).classList.add('hidden')); document.getElementById(`view-${t}`).classList.remove('hidden'); document.querySelectorAll('.nav-btn').forEach(b => { b.classList.remove('active', 'text-jp-accent'); b.classList.add('text-gray-300'); }); const btn = document.querySelector(`button[onclick="switchTab('${t}')"]`); btn.classList.remove('text-gray-300'); btn.classList.add('active', 'text-jp-accent'); if(t==='map') refreshMap(); }
        function openTaxiCard() { document.getElementById('modal-taxi').classList.remove('hidden'); }
        function closeModal(t) { document.getElementById(`modal-${t}`).classList.add('hidden'); }
        function convertCurrency(s) { const f = document.getElementById('conv-foreign'), h = document.getElementById('conv-home'); if(s==='foreign') h.value = (f.value * CONFIG.rate).toFixed(1); else f.value = (h.value / CONFIG.rate).toFixed(0); }
        function updateBadges() { const c = (db.shopping||[]).filter(i=>!i.done).length + (db.luggage||[]).filter(i=>!i.done).length; const el = document.getElementById('global-badge'); if(c>0) el.classList.remove('hidden'); else el.classList.add('hidden'); document.getElementById('menu-badge-shop').innerText = (db.shopping||[]).filter(i=>!i.done).length; document.getElementById('menu-badge-luggage').innerText = (db.luggage||[]).filter(i=>!i.done).length; }
        function exportData() { const s = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(db)); const n = document.createElement('a'); n.href = s; n.download = `trip_${new Date().toISOString().slice(0,10)}.json`; document.body.appendChild(n); n.click(); n.remove(); }
        function importData(i) { const f = i.files[0]; if(!f) return; const r = new FileReader(); r.onload = function(e) { try { db = JSON.parse(e.target.result); save(); alert("å·²é‚„åŸï¼"); location.reload(); } catch(e) { alert("æ ¼å¼éŒ¯èª¤"); } }; r.readAsText(f); }
        
        // Safety
        let audioCtx, osc, isSiren=false;
        function toggleSiren() { const b=document.getElementById('siren-btn'), t=document.getElementById('siren-text'); if(isSiren){ if(osc){osc.stop();osc.disconnect();osc=null;} isSiren=false; b.classList.remove('siren-active'); t.innerText="å•Ÿå‹•é˜²ç‹¼è­¦å ±"; } else { if(!audioCtx) audioCtx=new(window.AudioContext||window.webkitAudioContext)(); osc=audioCtx.createOscillator(); const g=audioCtx.createGain(); osc.type='sawtooth'; osc.frequency.setValueAtTime(800,audioCtx.currentTime); osc.frequency.linearRampToValueAtTime(1200,audioCtx.currentTime+0.3); osc.connect(g); g.connect(audioCtx.destination); const l=audioCtx.createOscillator(); l.type='square'; l.frequency.value=4; const lg=audioCtx.createGain(); lg.gain.value=400; l.connect(lg); lg.connect(osc.frequency); l.start(); osc.start(); isSiren=true; b.classList.add('siren-active'); t.innerText="è­¦å ±ä¸­ é»æ“Šé—œé–‰"; } }
        function saveContact() { db.settings.safetyContact = document.getElementById('safety-contact').value; save(); }
        function sendWhatsAppSOS() { const c = db.settings.safetyContact; if(!c) { alert("è«‹å…ˆè¼¸å…¥é›»è©±"); return; } navigator.geolocation.getCurrentPosition(p => { const url = `https://wa.me/${c}?text=${encodeURIComponent(`ç·Šæ€¥å ±å¹³å®‰: http://maps.google.com/?q=${p.coords.latitude},${p.coords.longitude}`)}`; location.href = url; }, () => alert("ç„¡æ³•å®šä½")); }
        function openNearby(t) { navigator.geolocation.getCurrentPosition(p => { const q = t==='police'?'äº¤ç•ª':t==='hospital'?'ç—…é™¢':'ã‚³ãƒ³ãƒ“ãƒ‹'; window.open(`https://www.google.com/maps/search/?api=1&query=${q}&center=${p.coords.latitude},${p.coords.longitude}`); }); }

        init();
    </script>
</body>
</html>
