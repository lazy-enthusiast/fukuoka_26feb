<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#FFFBF0">
    <title>ç¦å²¡ç™’æ—… (2/14-2/20)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&family=Zen+Maru+Gothic:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'jp-bg': '#FFFBF0', 
                        'jp-card': '#FFFFFF',
                        'jp-yellow': '#F3E4B2', 
                        'jp-text': '#595045', 
                        'jp-accent': '#D4A373', 
                        'jp-red': '#EF4444',
                        'jp-blue-light': '#E0F2FE',
                    },
                    fontFamily: {
                        sans: ['Zen Maru Gothic', 'Noto Sans JP', 'sans-serif'],
                    },
                    animation: {
                        'pulse-fast': 'pulse 1s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    }
                }
            }
        }
    </script>
    <style>
        body { -webkit-tap-highlight-color: transparent; overscroll-behavior-y: none; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .page-enter { animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        .modal-enter { animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(100%); } to { opacity: 1; transform: translateY(0); } }
        .glass { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border-top: 1px solid rgba(255, 255, 255, 0.8); }
        .siren-active { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both infinite; background-color: #EF4444 !important; color: white !important; border-color: #EF4444 !important; }
        @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }
        
        .nav-btn.active::after {
            content: ''; position: absolute; bottom: -6px; width: 4px; h: 4px; background: #D4A373; border-radius: 50%;
        }
        .flight-card { background-image: radial-gradient(circle at 0 50%, transparent 8px, white 9px), radial-gradient(circle at 100% 50%, transparent 8px, white 9px); background-color: white; background-position: 0px 50%, 100% 50%; background-size: 10px 20px, 10px 20px; background-repeat: no-repeat; }
    </style>
</head>
<body class="bg-jp-bg text-jp-text h-[100dvh] w-full flex flex-col overflow-hidden font-sans select-none">

    <header class="px-6 pt-12 pb-4 flex justify-between items-center bg-jp-bg z-30 relative">
        <div onclick="openTaxiCard()" class="cursor-pointer group">
            <h1 id="app-title" class="text-2xl font-bold tracking-widest text-jp-text flex items-center gap-2">
                FUKUOKA <i class="fa-solid fa-taxi text-xs text-white bg-jp-accent p-1.5 rounded-full group-active:scale-110 transition"></i>
            </h1>
            <p id="app-subtitle" class="text-xs text-gray-400 mt-1 tracking-wider">é¿å¹´ç™‚ç™’ä¹‹æ—… 2026</p>
        </div>
        
        <div class="flex gap-3">
            <button onclick="openModal('trip-info')" class="relative p-3 rounded-full bg-blue-50 text-blue-500 shadow-sm border border-blue-100 active:scale-95 transition">
                <i class="fa-solid fa-circle-info text-lg"></i>
            </button>
            
            <button onclick="openModal('safety')" class="relative p-3 rounded-full bg-red-50 text-red-500 shadow-sm border border-red-100 active:scale-95 transition">
                <i class="fa-solid fa-shield-halved text-lg"></i>
            </button>
            <button onclick="toggleMainMenu()" class="relative p-3 rounded-full bg-white shadow-sm active:scale-95 transition">
                <i class="fa-solid fa-bars text-lg text-jp-text"></i>
                <span id="global-badge" class="absolute top-1 right-1 w-2.5 h-2.5 bg-red-400 rounded-full border-2 border-white hidden"></span>
            </button>
        </div>

        <div id="main-menu" class="hidden absolute top-24 right-6 w-64 glass rounded-2xl shadow-[0_10px_40px_-10px_rgba(0,0,0,0.1)] p-2 z-50 transform origin-top-right transition-all duration-200 border border-white">
            <button onclick="openModal('luggage')" class="menu-item w-full text-left px-4 py-3 rounded-xl hover:bg-white/50 flex items-center gap-3 transition">
                <i class="fa-solid fa-suitcase text-purple-400 w-5"></i> è¡Œææ¸…å–®
                <span id="menu-badge-luggage" class="ml-auto text-[10px] bg-red-100 text-red-500 px-2 py-0.5 rounded-full hidden">0</span>
            </button>
            <button onclick="openModal('shopping')" class="menu-item w-full text-left px-4 py-3 rounded-xl hover:bg-white/50 flex items-center gap-3 transition">
                <i class="fa-solid fa-bag-shopping text-pink-400 w-5"></i> è³¼ç‰©æ¸…å–®
                <span id="menu-badge-shop" class="ml-auto text-[10px] bg-red-100 text-red-500 px-2 py-0.5 rounded-full hidden">0</span>
            </button>
            <button onclick="openModal('todo')" class="menu-item w-full text-left px-4 py-3 rounded-xl hover:bg-white/50 flex items-center gap-3 transition">
                <i class="fa-solid fa-check-circle text-blue-400 w-5"></i> å¾…è¾¦äº‹é …
            </button>
            <div class="my-2 border-t border-gray-100/50"></div>
            <button onclick="exportData()" class="menu-item w-full text-left px-4 py-3 rounded-xl hover:bg-white/50 flex items-center gap-3 transition text-sm">
                <i class="fa-solid fa-download text-gray-400 w-5"></i> å‚™ä»½è¡Œç¨‹
            </button>
            <button onclick="document.getElementById('file-input').click()" class="menu-item w-full text-left px-4 py-3 rounded-xl hover:bg-white/50 flex items-center gap-3 transition text-sm">
                <i class="fa-solid fa-upload text-gray-400 w-5"></i> é‚„åŸè¡Œç¨‹
            </button>
            <input type="file" id="file-input" class="hidden" accept=".json" onchange="importData(this)">
        </div>
        <div id="menu-overlay" onclick="toggleMainMenu()" class="hidden fixed inset-0 z-40 bg-black/5"></div>
    </header>

    <div class="pl-6 py-2 bg-jp-bg z-10">
        <div id="date-slider" class="flex gap-4 overflow-x-auto no-scrollbar pr-6 pb-4"></div>
    </div>

    <main id="main-container" class="flex-1 overflow-y-auto px-6 pb-20 relative scroll-smooth no-scrollbar">
        <div id="view-itinerary" class="page-enter space-y-5">
            <div id="weather-widget" class="bg-white/60 border border-white backdrop-blur-sm p-4 rounded-3xl shadow-sm flex items-center justify-between hidden">
                <div class="flex items-center gap-4">
                    <div id="weather-icon" class="text-3xl text-orange-400"><i class="fa-solid fa-sun"></i></div>
                    <div>
                        <div class="text-[10px] text-gray-400 font-bold mb-0.5 tracking-wider uppercase">Forecast</div>
                        <div class="text-xl font-bold text-jp-text" id="weather-temp">--Â°C</div>
                    </div>
                </div>
                <div class="text-right">
                    <div class="text-xs text-blue-500 bg-blue-50 px-3 py-1 rounded-full font-bold" id="weather-desc">æ™´æœ—</div>
                </div>
            </div>

            <div class="flex justify-between items-end px-1">
                <h2 class="text-lg font-bold text-jp-text">ä»Šæ—¥è¨ˆç•«</h2>
                <div class="text-[10px] text-gray-400 bg-white px-2 py-1 rounded-full shadow-sm">é•·æŒ‰æ‹–æ›³</div>
            </div>
            <div id="itinerary-list" class="space-y-4 pb-10"></div>
            
            <button onclick="openAddModal('itinerary')" class="w-full py-4 rounded-2xl border-2 border-dashed border-jp-accent/30 text-jp-accent font-bold hover:bg-white transition flex justify-center items-center gap-2 group">
                <i class="fa-solid fa-plus group-hover:scale-110 transition"></i> æ–°å¢è¡Œç¨‹
            </button>
        </div>

        <div id="view-map" class="hidden h-full flex flex-col page-enter">
            <div class="bg-white p-3 rounded-2xl shadow-sm mb-3 text-sm flex gap-2 items-center justify-between z-10">
                <div class="flex items-center gap-2 text-xs text-gray-500">
                    <i class="fa-solid fa-location-dot text-red-400"></i>
                    <span id="map-status">è¼‰å…¥ä¸­...</span>
                </div>
                <button onclick="refreshMap()" class="text-[10px] text-blue-500 bg-blue-50 px-3 py-1.5 rounded-full font-bold">é‡æ•´</button>
            </div>
            <div id="osm-map" class="flex-1 w-full rounded-[2rem] overflow-hidden shadow-inner bg-gray-100 relative z-0 border-4 border-white"></div>
        </div>

        <div id="view-finance" class="hidden page-enter space-y-6">
            <div class="bg-gradient-to-br from-jp-text to-gray-700 rounded-3xl p-6 text-white shadow-lg shadow-gray-200">
                <div class="text-xs text-white/60 mb-1">æœ¬æ—¥ç¸½æ”¯å‡º</div>
                <div class="flex items-baseline gap-1">
                    <span class="text-3xl font-bold currency-icon-foreign">Â¥</span>
                    <span class="text-4xl font-bold" id="daily-total-foreign">0</span>
                </div>
                <div class="mt-2 text-sm text-white/60 flex justify-between items-center">
                    <span>ç´„ <span class="currency-icon-home">$</span> <span id="daily-total-home">0</span></span>
                    <button onclick="openAddModal('expense')" class="bg-white/20 hover:bg-white/30 px-3 py-1.5 rounded-full text-xs transition backdrop-blur-md">
                        <i class="fa-solid fa-plus mr-1"></i> è¨˜ä¸€ç­†
                    </button>
                </div>
            </div>
            <div id="expense-list" class="space-y-3 pb-20"></div>
        </div>

        <div id="view-info" class="hidden page-enter space-y-5">
             <div class="flex justify-between items-center">
                <h2 class="text-lg font-bold">æ—…äººç­†è¨˜</h2>
                <button onclick="openAddModal('info')" class="text-jp-accent w-8 h-8 flex items-center justify-center bg-white rounded-full shadow-sm"><i class="fa-solid fa-plus"></i></button>
            </div>
            <div id="info-list" class="grid grid-cols-1 gap-4 pb-20"></div>
        </div>
    </main>

    <nav class="fixed bottom-0 left-0 right-0 w-full glass z-40 flex justify-between items-end px-8 pt-2 pb-6 rounded-t-[2rem] shadow-[0_-5px_20px_rgba(0,0,0,0.03)]">
        <button onclick="switchTab('itinerary')" class="nav-btn active relative flex flex-col items-center gap-0.5 text-jp-accent w-12 transition-all duration-300">
            <i class="fa-solid fa-calendar-day text-xl"></i>
            <span class="text-[10px] font-bold">è¡Œç¨‹</span>
        </button>
        <button onclick="switchTab('map')" class="nav-btn relative flex flex-col items-center gap-0.5 text-gray-300 hover:text-jp-text w-12 transition-all duration-300">
            <i class="fa-solid fa-map text-xl"></i>
            <span class="text-[10px] font-bold">åœ°åœ–</span>
        </button>
        <button onclick="switchTab('finance')" class="nav-btn relative flex flex-col items-center gap-0.5 text-gray-300 hover:text-jp-text w-12 transition-all duration-300">
            <i class="fa-solid fa-wallet text-xl"></i>
            <span class="text-[10px] font-bold">è¨˜å¸³</span>
        </button>
        <button onclick="openModal('converter')" class="nav-btn relative flex flex-col items-center gap-0.5 text-gray-300 hover:text-jp-text w-12 transition-all duration-300">
            <i class="fa-solid fa-calculator text-xl"></i>
            <span class="text-[10px] font-bold">æ›ç®—</span>
        </button>
    </nav>

    <div id="modal-trip-info" class="fixed inset-0 bg-black/40 backdrop-blur-sm z-[80] hidden flex items-center justify-center p-6" onclick="if(event.target===this)closeModal('trip-info')">
        <div class="bg-gray-50 w-full max-w-sm rounded-[2rem] p-6 shadow-2xl page-enter max-h-[85vh] overflow-y-auto no-scrollbar relative">
            
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-jp-text flex items-center gap-2">
                    <i class="fa-solid fa-passport text-jp-accent"></i> æ—…ç¨‹è³‡è¨Š
                </h3>
                <button onclick="closeModal('trip-info')" class="w-8 h-8 bg-white rounded-full text-gray-300 shadow-sm flex items-center justify-center">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>

            <div class="bg-white p-5 rounded-2xl shadow-sm mb-4 border border-gray-100">
                <div class="flex items-center gap-3 mb-3 border-b border-gray-50 pb-3">
                    <div class="w-8 h-8 bg-jp-yellow rounded-full flex items-center justify-center text-jp-text text-sm"><i class="fa-solid fa-bed"></i></div>
                    <span class="text-sm font-bold text-jp-text">ä½å®¿é£¯åº—</span>
                </div>
                <h4 class="font-bold text-jp-text text-lg leading-tight mb-2">Hotel Wing International<br><span class="text-sm text-gray-400 font-normal">Hakata Shinkansen</span></h4>
                <p class="text-xs text-gray-500 bg-gray-50 p-2 rounded-lg mb-2"><i class="fa-solid fa-location-dot mr-1"></i>ç¦å²¡å¸‚åšå¤šåŒºåšå¤šé§…æ±1-17-17</p>
                
                <div class="flex gap-2 text-xs text-gray-500 mb-3">
                    <span class="bg-gray-50 px-2 py-1 rounded border border-gray-100">IN 15:00</span>
                    <span class="bg-gray-50 px-2 py-1 rounded border border-gray-100">OUT 11:00</span>
                </div>
                
                <p class="text-[10px] text-jp-accent font-bold bg-orange-50 p-2 rounded border border-orange-100">
                    <i class="fa-solid fa-person-walking-luggage mr-1"></i>æŒ‡å¼•ï¼šç­‘ç´«å£æ­¥è¡Œ4åˆ†é˜ï¼Œæ²¿åšå¤šé§…æ±è¡—ç›´èµ°ï¼Œéä¸€å€‹å°è·¯å£å¾Œå³æ‰‹é‚Šã€‚
                </p>
            </div>

            <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 relative overflow-hidden">
                <div class="flex items-center gap-3 mb-3 border-b border-gray-50 pb-3 relative z-10">
                    <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center text-blue-500 text-sm"><i class="fa-solid fa-plane"></i></div>
                    <span class="text-sm font-bold text-jp-text">èˆªç­è³‡è¨Š (HK Express)</span>
                </div>

                <div class="flex justify-between items-center mb-4 relative z-10">
                    <div>
                        <div class="text-[10px] text-gray-400 font-bold mb-1">2/14 (å…­) å»ç¨‹</div>
                        <div class="text-2xl font-bold text-jp-text font-mono">UO638</div>
                    </div>
                    <div class="text-right">
                        <div class="text-xl font-bold text-jp-text">17:10 <span class="text-xs text-gray-400 font-normal">æŠµé”</span></div>
                        <div class="text-[10px] text-gray-400">FUK ç¦å²¡æ©Ÿå ´</div>
                    </div>
                </div>

                <div class="border-t border-dashed border-gray-200 my-3"></div>

                <div class="flex justify-between items-center relative z-10">
                    <div>
                        <div class="text-[10px] text-gray-400 font-bold mb-1">2/20 (äº”) å›ç¨‹</div>
                        <div class="text-2xl font-bold text-jp-text font-mono">UO669</div>
                    </div>
                    <div class="text-right">
                        <div class="text-xl font-bold text-jp-text">16:05 <span class="text-xs text-gray-400 font-normal">èµ·é£›</span></div>
                        <div class="text-[10px] text-gray-400">FUK ç¦å²¡æ©Ÿå ´</div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <div id="modal-safety" class="fixed inset-0 bg-red-50/90 backdrop-blur-md z-[60] hidden flex flex-col justify-end">
        <div class="bg-white w-full rounded-t-[2.5rem] p-6 pb-10 modal-enter shadow-[0_-10px_60px_rgba(239,68,68,0.2)]">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold flex items-center gap-2 text-red-500"><i class="fa-solid fa-shield-heart"></i> å®‰å…¨å®ˆè­·</h2>
                <button onclick="closeModal('safety')" class="w-8 h-8 flex items-center justify-center bg-gray-50 rounded-full text-gray-300"><i class="fa-solid fa-xmark"></i></button>
            </div>

            <button id="siren-btn" onclick="toggleSiren()" class="w-full py-5 bg-white border-2 border-red-100 rounded-2xl flex items-center justify-center gap-3 text-red-500 font-bold mb-6 shadow-sm active:scale-[0.98] transition">
                <i class="fa-solid fa-bullhorn text-2xl"></i>
                <span id="siren-text">å•Ÿå‹•é˜²ç‹¼è­¦å ± (æœ€å¤§è²)</span>
            </button>

            <div class="mb-6">
                <label class="text-xs text-gray-400 font-bold ml-1 mb-2 block">ä¸€éµå ±å¹³å®‰ (WhatsApp)</label>
                <div class="flex gap-2 mb-2">
                    <input type="tel" id="safety-contact" class="flex-1 bg-gray-50 px-4 py-3 rounded-xl text-sm outline-none border border-gray-100" placeholder="è¼¸å…¥è¯çµ¡äººé›»è©± (å«å€è™Ÿ ä¾‹å¦‚ 85291234567)">
                    <button onclick="saveContact()" class="bg-gray-800 text-white px-4 rounded-xl text-xs font-bold whitespace-nowrap">å„²å­˜</button>
                </div>
                <button onclick="sendWhatsAppSOS()" class="w-full bg-[#25D366] text-white py-4 rounded-xl font-bold flex items-center justify-center gap-2 shadow-lg shadow-green-100 active:scale-[0.98] transition">
                    <i class="fa-brands fa-whatsapp text-xl"></i> å‚³é€ä½ç½®å ±å¹³å®‰
                </button>
                <p class="text-[10px] text-gray-300 mt-2 text-center">*é»æ“Šå¾Œæœƒé–‹å•Ÿ WhatsApp ä¸¦é å¡« Google Maps é€£çµ</p>
            </div>

            <div class="grid grid-cols-3 gap-3 pt-4 border-t border-gray-100">
                <button onclick="openNearby('police')" class="flex flex-col items-center gap-2 p-3 rounded-xl bg-blue-50 text-blue-500 hover:bg-blue-100 transition">
                    <i class="fa-solid fa-building-shield text-xl"></i>
                    <span class="text-xs font-bold">æ´¾å‡ºæ‰€</span>
                </button>
                <button onclick="openNearby('hospital')" class="flex flex-col items-center gap-2 p-3 rounded-xl bg-red-50 text-red-500 hover:bg-red-100 transition">
                    <i class="fa-solid fa-hospital text-xl"></i>
                    <span class="text-xs font-bold">é†«é™¢</span>
                </button>
                <button onclick="openNearby('convenience_store')" class="flex flex-col items-center gap-2 p-3 rounded-xl bg-orange-50 text-orange-500 hover:bg-orange-100 transition">
                    <i class="fa-solid fa-store text-xl"></i>
                    <span class="text-xs font-bold">ä¾¿åˆ©åº—</span>
                </button>
            </div>
        </div>
    </div>

    <div id="modal-taxi" class="fixed inset-0 bg-jp-text z-[70] hidden flex flex-col items-center justify-center p-6 text-center page-enter" onclick="closeModal('taxi')">
        <div class="text-white/50 text-sm mb-4 animate-pulse">è«‹å‡ºç¤ºæ­¤ç•«é¢çµ¦å¸æ©Ÿ</div>
        <div class="bg-white text-black p-8 rounded-xl w-full max-w-sm shadow-2xl transform rotate-1">
            <h2 class="text-2xl font-bold mb-4 border-b-2 border-black pb-2">ãƒ›ãƒ†ãƒ«ã¸ãŠé¡˜ã„ã—ã¾ã™</h2>
            <p class="text-2xl font-bold mb-4 leading-tight">Hotel Wing International<br>Hakata Shinkansenguchi</p>
            <p class="text-lg font-bold text-gray-500 mb-1">ä½æ‰€ï¼š</p>
            <p class="text-xl font-bold bg-yellow-100 p-3 rounded leading-relaxed">ç¦å²¡å¸‚åšå¤šåŒºåšå¤šé§…æ±<br>1-17-17</p>
             <div class="mt-4 text-left bg-gray-50 p-3 rounded-lg border border-gray-200">
                <p class="text-xs text-gray-400 font-bold mb-1">è·¯ç—´æ•‘æ˜ŸæŒ‡å¼•ï¼š</p>
                <p class="text-sm text-gray-600 leading-relaxed">å¾åšå¤šç«™ç­‘ç´«å£æ­¥è¡Œ4åˆ†é˜ã€‚å…¥å£åœ¨ç­‘ç´«å£æ±å´ï¼Œæ²¿è‘—åšå¤šé§…æ±è¡—ç›´èµ°ï¼Œéä¸€å€‹å°è·¯å£å¾Œå³æ‰‹é‚Šå³è¦‹é£¯åº—æ‹›ç‰Œã€‚</p>
            </div>
        </div>
        <div class="mt-8 text-white/50 text-xs"><i class="fa-solid fa-hand-point-up mr-2"></i>é»æ“Šä»»æ„è™•é—œé–‰</div>
    </div>

    <div id="modal-converter" class="fixed inset-0 bg-black/40 backdrop-blur-sm z-50 hidden flex items-center justify-center px-6">
        <div class="bg-white w-full max-w-xs rounded-[2rem] p-6 page-enter shadow-2xl relative">
            <button onclick="closeModal('converter')" class="absolute top-4 right-4 w-8 h-8 flex items-center justify-center bg-gray-50 rounded-full text-gray-300"><i class="fa-solid fa-xmark"></i></button>
            <h3 class="font-bold mb-6 text-jp-text text-center">å³æ™‚åŒ¯ç‡æ›ç®—</h3>
            <div class="bg-jp-bg rounded-2xl p-4 mb-2 border border-orange-100">
                <label class="text-[10px] text-gray-400 block mb-1 font-bold tracking-wider"><span class="currency-foreign">JPY</span></label>
                <div class="flex items-center"><span class="text-xl font-bold mr-2 text-jp-accent currency-icon-foreign">Â¥</span><input type="number" id="conv-foreign" class="bg-transparent text-3xl font-bold w-full outline-none text-jp-text" placeholder="0" oninput="convertCurrency('foreign')"></div>
            </div>
            <div class="flex justify-center -my-5 relative z-10"><div class="bg-white border border-gray-100 rounded-full p-2 shadow-sm"><i class="fa-solid fa-arrow-down-up text-gray-300 text-xs"></i></div></div>
            <div class="bg-gray-50 rounded-2xl p-4 mt-2 border border-gray-100">
                <label class="text-[10px] text-gray-400 block mb-1 font-bold tracking-wider"><span class="currency-home">HKD</span> <span class="text-[10px] ml-1 bg-gray-200 px-1 rounded text-gray-500" id="rate-display"></span></label>
                <div class="flex items-center"><span class="text-xl font-bold mr-2 text-gray-400 currency-icon-home">$</span><input type="number" id="conv-home" class="bg-transparent text-3xl font-bold w-full outline-none text-gray-500" placeholder="0" oninput="convertCurrency('home')"></div>
            </div>
        </div>
    </div>

    <div id="modal-generic" class="fixed inset-0 bg-black/30 backdrop-blur-sm z-50 hidden flex justify-end">
        <div class="bg-jp-bg w-full max-w-md h-full shadow-2xl flex flex-col modal-enter relative rounded-l-3xl overflow-hidden">
            <div class="p-6 bg-white flex justify-between items-center shadow-sm z-10">
                <h2 id="generic-title" class="text-xl font-bold flex items-center gap-2 text-jp-text">æ¸…å–®</h2>
                <button onclick="closeGenericModal()" class="w-8 h-8 flex items-center justify-center bg-gray-50 rounded-full text-gray-400"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="p-4 bg-white/50 border-b border-white">
                <div class="flex gap-2">
                    <input type="text" id="generic-input" class="flex-1 bg-white rounded-xl px-4 py-3 outline-none text-sm shadow-sm border border-gray-100 placeholder-gray-300 transition focus:border-jp-accent" placeholder="æ–°å¢é …ç›®...">
                    <button onclick="addGenericItem()" class="bg-jp-text text-white w-12 rounded-xl shadow-lg shadow-gray-200"><i class="fa-solid fa-plus"></i></button>
                </div>
            </div>
            <ul id="generic-list" class="flex-1 overflow-y-auto p-4 space-y-3 pb-10"></ul>
        </div>
    </div>

    <div id="detail-modal" class="fixed inset-0 bg-black/40 backdrop-blur-md z-50 hidden flex items-end sm:items-center justify-center">
        <div class="bg-white w-full sm:w-96 rounded-t-[2.5rem] sm:rounded-[2.5rem] p-8 pb-10 page-enter relative max-h-[90vh] overflow-y-auto no-scrollbar shadow-[0_-10px_40px_rgba(0,0,0,0.2)]">
            <div class="absolute top-3 left-1/2 -translate-x-1/2 w-12 h-1.5 bg-gray-200 rounded-full sm:hidden"></div>
            
            <div class="flex flex-col items-center mb-6">
                <div id="detail-icon-bg" class="w-20 h-20 rounded-full flex items-center justify-center text-3xl mb-4 shadow-lg ring-4 ring-white"><i id="detail-icon" class="fa-solid"></i></div>
                <h2 id="detail-title" class="text-2xl font-bold text-jp-text text-center leading-tight">æ¨™é¡Œ</h2>
                <div id="detail-time" class="text-jp-accent font-bold mt-2 bg-orange-50 px-3 py-1 rounded-full text-sm font-mono"></div>
            </div>
            
            <div class="space-y-4">
                <div id="detail-booking-container" class="hidden">
                    <div class="bg-jp-blue-light p-5 rounded-2xl border border-blue-100 relative overflow-hidden group">
                        <div class="absolute -right-4 -bottom-4 text-blue-200 text-7xl opacity-30 rotate-12 group-hover:rotate-0 transition duration-500"><i class="fa-solid fa-ticket"></i></div>
                        <div class="relative z-10">
                            <div class="text-[10px] text-blue-400 font-bold mb-1 uppercase tracking-widest">Booking Info</div>
                            <div class="text-xs text-gray-500 mb-1" id="detail-bk-platform">å¹³å°</div>
                            <div class="text-2xl font-bold text-jp-blue-text font-mono tracking-wider" id="detail-bk-ref">#</div>
                        </div>
                    </div>
                </div>

                <a id="detail-link" href="#" target="_blank" class="hidden w-full py-4 bg-jp-text text-white font-bold rounded-xl text-center shadow-lg active:scale-95 transition flex items-center justify-center gap-2">
                    <i class="fa-solid fa-link"></i> é–‹å•Ÿé ç´„ / å®˜ç¶²
                </a>

                <button onclick="openExternalMap()" class="w-full flex items-center justify-between bg-gray-50 text-gray-600 p-4 rounded-2xl border border-gray-100 active:bg-gray-100 transition">
                    <div class="flex items-center gap-3 overflow-hidden">
                        <div class="w-8 h-8 rounded-full bg-white flex items-center justify-center text-red-500 shadow-sm flex-shrink-0"><i class="fa-solid fa-location-dot"></i></div>
                        <span id="detail-loc" class="font-bold text-sm truncate">åœ°é»åç¨±</span>
                    </div>
                    <i class="fa-solid fa-arrow-up-right-from-square text-xs text-gray-400"></i>
                </button>
                
                <div class="bg-jp-bg p-5 rounded-2xl border border-orange-50">
                    <div class="text-[10px] text-gray-400 mb-2 font-bold uppercase tracking-wider">Note</div>
                    <div id="detail-note" class="text-sm text-gray-600 leading-relaxed whitespace-pre-line"></div>
                </div>
            </div>

            <div class="flex gap-3 mt-8">
                <button onclick="closeDetailModal()" class="flex-1 py-3 text-gray-400 font-bold rounded-xl hover:bg-gray-50 transition">é—œé–‰</button>
                <button onclick="deleteFromDetail()" class="flex-1 py-3 bg-red-50 text-red-400 font-bold rounded-xl hover:bg-red-100 transition"><i class="fa-solid fa-trash-can mr-2"></i>åˆªé™¤</button>
            </div>
        </div>
    </div>

    <div id="add-modal" class="fixed inset-0 bg-black/40 backdrop-blur-sm z-50 hidden flex items-end sm:items-center justify-center">
        <div class="bg-white w-full sm:w-96 rounded-t-3xl sm:rounded-3xl p-6 pb-8 page-enter relative max-h-[90vh] overflow-y-auto no-scrollbar">
            <div class="flex justify-between items-center mb-6">
                <h3 id="modal-title" class="text-xl font-bold text-jp-text">æ–°å¢</h3>
                <button onclick="closeAddModal()" class="w-8 h-8 bg-gray-50 rounded-full text-gray-300"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <form id="add-form" onsubmit="handleFormSubmit(event)" class="space-y-4">
                <div id="modal-content"></div>
                <button type="submit" class="w-full bg-jp-text text-white font-bold py-4 rounded-xl shadow-lg mt-6 active:scale-[0.98] transition">ç¢ºèªå„²å­˜</button>
            </form>
        </div>
    </div>

    <script>
        const CONFIG = {
            key: "fukuoka_trip_2026_full_detail_v2",
            dates: ["2026-02-14", "2026-02-15", "2026-02-16", "2026-02-17", "2026-02-18", "2026-02-19", "2026-02-20"],
            rate: 0.052,
            hotel: { jp: "ç¦å²¡å¸‚åšå¤šåŒºåšå¤šé§…æ±1-17-17", name: "Hotel Wing International", coords: [33.5910, 130.4225] },
            defaultItinerary: [
                // Day 1: Feb 14 (Sat) - Arrival
                { id: 101, date: "2026-02-14", time: "17:10", type: "flight", title: "æŠµé”ç¦å²¡æ©Ÿå ´ (UO638)", loc: "Fukuoka Airport", lat: 33.5859, lng: 130.4446, 
                  note: "ã€äº¤é€šæŒ‡ç¤ºã€‘\n1. å…¥å¢ƒå¾Œç›´èµ°ç´„50ç±³ï¼Œå‰å¾€ã€Œ2è™Ÿå·´å£«ä¹˜è»Šè™•ã€ã€‚\n2. æ­ä¹˜ã€Œè¥¿éµå·´å£« (å¾€åšå¤šé§…ãƒ»å¤©ç¥æ–¹å‘)ã€ã€‚\n3. åœ¨ã€Œåšå¤šé§…ç­‘ç´«å£ã€ä¸‹è»Š (ç´„ç¬¬3ç«™)ã€‚\nè²»ç”¨ï¼šÂ¥310 (ICå¡/ç¾é‡‘)ã€‚æ™‚é–“ï¼šç´„20åˆ†é˜ã€‚", bookingRef: "UO638" },
                
                { id: 102, date: "2026-02-14", time: "18:20", type: "other", title: "é£¯åº— Check-in", loc: "Hotel Wing International", lat: 33.5910, lng: 130.4225, 
                  note: "ã€æ­¥è¡ŒæŒ‡å¼•ã€‘\nä¸‹è»Šå¾Œï¼Œå…¥å£åœ¨ç­‘ç´«å£æ±å´ï¼Œæ²¿è‘—åšå¤šé§…æ±è¡—ç›´èµ°ï¼Œéä¸€å€‹å°è·¯å£å¾Œå³æ‰‹é‚Šå³è¦‹é£¯åº—æ‹›ç‰Œ (ç´„4åˆ†é˜)ã€‚\nCheck-inå¾Œè¨˜å¾—æ‹¿å¤§å ‚åœ°åœ–ã€‚", bookingRef: "", link: "https://www.hotelwing.co.jp/hakata-shinkansen/" },
                
                { id: 103, date: "2026-02-14", time: "18:45", type: "shopping", title: "ä½å‰é…’è²© (è§’æ‰“é«”é©—)", loc: "Hakata Deitos Annex 1F", lat: 33.5905, lng: 130.4195, 
                  note: "ã€äº¤é€šã€‘å¾é£¯åº—èµ°å›åšå¤šç«™ç­‘ç´«å£ï¼Œé€²ç«™å¾Œè·Ÿéš¨ 'Deitos Annex' æ¨™èªŒï¼Œç›´èµ°100ç±³å·¦æ‰‹é‚Šã€‚\n\nã€é«”é©—ã€‘æ›è³¼ã€ŒèŠ±æœ­ã€ä»£å¹£ (Â¥500èµ·) å…Œæ›é…’èˆ‡å°èœã€‚\nğŸ’¡ç´€å¿µå“ï¼šä¹å·é™å®šæ¸…é…’ç“¶ã€‚", bookingRef: "" },
                
                { id: 104, date: "2026-02-14", time: "19:30", type: "food", title: "åšå¤šç‰›è…¸é‹ é£¯å±±", loc: "Hakata Deitos 1F", lat: 33.5905, lng: 130.4195, 
                  note: "ã€äº¤é€šã€‘å¾ä½å‰é…’è²©å‡ºä¾†ï¼Œæ²¿å•†å ´èµ°50ç±³ï¼Œå³æ‰‹é‚Šã€Œåšå¤šéºµè¡—é“ã€ä¸‹æ¨“æ¢¯ã€‚\n\nğŸ½ï¸ å¿…é»ï¼šå‘³å™Œç‰›è…¸é‹ã€ç”Ÿå•¤é…’ã€‚\nğŸ’° é ç®—ï¼šÂ¥2,500ã€‚", bookingRef: "", link: "https://resy.com/cities/fukuoka-japan/venues/hakata-motsunabe-ooyama-deitos-hakata" },
                
                { id: 105, date: "2026-02-14", time: "21:00", type: "food", title: "èŒ¶é…’æ²™é¾ Yorozu", loc: "èµ¤å‚2-3-32", lat: 33.5865, lng: 130.3940, 
                  note: "ã€äº¤é€šã€‘åœ°éµç©ºæ¸¯ç·šã€Œèµ¤å‚ç«™ã€2è™Ÿå‡ºå£ï¼Œå‡ºç«™å·¦è½‰ç›´èµ°300ç±³ã€‚\n\nğŸ½ï¸ å¿…é»ï¼šèŒ¶é…’å¥—é¤ (Tea Cocktail Course)ã€‚\nğŸ’° é ç®—ï¼šÂ¥5,000ã€‚\nğŸ’¡ç´€å¿µå“ï¼šèŒ¶è‘‰åŒ…/å°é…’ç“¶ã€‚", bookingRef: "éœ€é ç´„", link: "https://autoreserve.com/zh-tw/restaurants/QrFYAjJWeRj4e6cev4nr" },

                // Day 2: Feb 15 (Sun) - Sake Festival
                { id: 201, date: "2026-02-15", time: "08:30", type: "food", title: "åšå¤šç‰›èˆŒæ—©é¤ Tandoya", loc: "åšå¤šä¸€ç•ªè¡— B1", lat: 33.5898, lng: 130.4200, 
                  note: "ã€äº¤é€šã€‘åšå¤šç«™ç­‘ç´«å£é€²ç«™ï¼Œè·Ÿéš¨ã€Œåšå¤šä¸€ç•ªè¡—ã€æ¨™èªŒä¸‹æ¨“åˆ°B1ã€‚\n\nğŸ½ï¸ å¿…é»ï¼šç‰›èˆŒæ—©é¤å®šé£Ÿ (Â¥800)ã€‚", bookingRef: "" },
                
                { id: 202, date: "2026-02-15", time: "09:30", type: "transport", title: "å‰å¾€åŸå³¶é…’è—é–‹å€‰", loc: "JRåšå¤šç«™ -> è’æœ¨ç«™", lat: 33.2925, lng: 130.4900, 
                  note: "è·¯ç·šï¼šJRé¹¿å…’å³¶æœ¬ç·š (å¿«é€Ÿ) -> ã€Œè’æœ¨ç«™ã€ (ç´„30åˆ†, Â¥1,130)ã€‚\nè½‰ä¹˜ï¼šå‡ºç«™å³æ‰‹é‚Šæ­å…è²»æ¥é§å·´å£«ã€‚", bookingRef: "" },
                
                { id: 203, date: "2026-02-15", time: "11:00", type: "sightseeing", title: "ç¬¬32å› åŸå³¶é…’è—é–‹å€‰", loc: "ä¹…ç•™ç±³å¸‚åŸå³¶ç”º", lat: 33.2750, lng: 130.4700, 
                  note: "ã€æ”»ç•¥ã€‘ä¸»æœƒå ´è²·è©¦é£²åˆ¸ï¼Œæ­å·¡è¿´å·´å£«è‡³é…’é€  (æ¨è–¦: æ¯”ç¿¼é¶´é…’é€ )ã€‚\nğŸ½ï¸ å¿…åƒï¼šé°»é­šè’¸ç± é£¯ã€‚\nğŸ’¡ç´€å¿µå“ï¼šé™é‡æ–°é…’ç“¶ã€‚", bookingRef: "", link: "https://welcome-kurume.com/tw/events/detail/aafc88d1-e520-4a74-849f-a2f54b58a68f" },
                
                { id: 204, date: "2026-02-15", time: "16:30", type: "shopping", title: "LOPIA è¶…å¸‚ åšå¤šåº—", loc: "Yodobashi Camera 4F", lat: 33.5885, lng: 130.4220, 
                  note: "ã€äº¤é€šã€‘åšå¤šç«™ç­‘ç´«å£å³è½‰èµ°100ç±³è‡³Yodobashiï¼Œé›»æ¢¯ä¸Š4Fã€‚\nâš ï¸ æ³¨æ„ï¼šåªæ”¶ç¾é‡‘ï¼è«‹æº–å‚™è¶³å¤ ç¾é‡‘ã€‚", bookingRef: "" },
                
                { id: 205, date: "2026-02-15", time: "18:30", type: "food", title: "åšå¤šé›çš®å¤§è‡£", loc: "KITTE åšå¤š B1", lat: 33.5890, lng: 130.4185, 
                  note: "ã€äº¤é€šã€‘åšå¤šç«™åšå¤šå£å·¦å´ KITTE å¤§æ¨“ B1ã€‚\nğŸ½ï¸ å¿…é»ï¼šé†¬æ±é›çš®ã€Highballã€‚", bookingRef: "" },

                // Day 3: Feb 16 (Mon) - Dazaifu
                { id: 301, date: "2026-02-16", time: "08:45", type: "food", title: "il FORNO del MIGNON", loc: "åšå¤šç«™ä¸­å¤®æ”¹æœ­å£", lat: 33.5900, lng: 130.4205, 
                  note: "ã€äº¤é€šã€‘åšå¤šç«™ä¸­å¤®æ”¹æœ­å£å…§ (Central Gate)ã€‚\nå¿…è²·ï¼šç¾çƒ¤è¿·ä½ å¯é Œã€‚", bookingRef: "" },
                
                { id: 302, date: "2026-02-16", time: "09:30", type: "transport", title: "å·´å£«å‰å¾€å¤ªå®°åºœ", loc: "åšå¤šå·´å£«ç¸½ç«™ 11è™Ÿæœˆå°", lat: 33.5915, lng: 130.4190, 
                  note: "è·¯ç·šï¼šæ­ä¹˜ã€Œæ—…äººè™Ÿ (Tabito)ã€ å·´å£« (Â¥610ï¼ŒICå¡å¯)ã€‚", bookingRef: "" },
                
                { id: 303, date: "2026-02-16", time: "10:30", type: "sightseeing", title: "å¤ªå®°åºœå¤©æ»¿å®® & ç«ˆé–€ç¥ç¤¾", loc: "å¤ªå®°åºœå¸‚", lat: 33.5215, lng: 130.5349, 
                  note: "ã€ç«ˆé–€ç¥ç¤¾äº¤é€šã€‘è¥¿éµå¤ªå®°åºœç«™å‰æ­ç¤¾å€å·´å£«ã€ŒMahorobaã€(å…§å±±ç·š) (Â¥100)ã€‚\nğŸ’¡ç´€å¿µå“ï¼šå¤©æ»¿å®®å¾¡å®ˆã€ç·£çµã³å®ˆã€‚", bookingRef: "" },
                
                { id: 304, date: "2026-02-16", time: "12:30", type: "food", title: "èŒ¶å’Œã€… (Sawawa)", loc: "å¤ªå®°åºœåƒé“", lat: 33.5200, lng: 130.5335, 
                  note: "ğŸ½ï¸ å¿…åƒï¼šæ¥µæ¿ƒæŠ¹èŒ¶é›ªç³• (Â¥800)ã€‚", bookingRef: "" },
                
                { id: 305, date: "2026-02-16", time: "14:30", type: "other", title: "äºŒæ—¥å¸‚æº«æ³‰ã€Œåšå¤šæ¹¯ã€", loc: "äºŒæ—¥å¸‚", lat: 33.4930, lng: 130.5250, 
                  note: "ã€äº¤é€šã€‘è¥¿éµäºŒæ—¥å¸‚ç«™è¥¿å£å‡ºï¼Œå³è½‰æ²¿æ¹¯ç”ºè¡—èµ°12åˆ†ã€‚\nè²»ç”¨ï¼šå…¥æµ´æ–™Â¥350ï¼Œæ¯›å·¾Â¥200ã€‚\nå¤æ¹¯æ”¾é¬†é«”é©—ã€‚", bookingRef: "" },
                
                { id: 306, date: "2026-02-16", time: "19:00", type: "food", title: "æ—­è»’ é§…å‰æœ¬åº—", loc: "åšå¤šé§…å‰2-15-22", lat: 33.5905, lng: 130.4170, 
                  note: "ğŸ½ï¸ å¿…é»ï¼šä¸€å£ç…é¤ƒã€ç‚¸é›ç¿…ã€‚\nğŸ’° é ç®—ï¼šÂ¥1,500ã€‚", bookingRef: "" },

                // Day 4: Feb 17 (Tue) - Beer & Buddha
                { id: 401, date: "2026-02-17", time: "08:15", type: "food", title: "å› å¹¡çƒé¾éºµ", loc: "åšå¤š Deitos 1F éºµè¡—é“", lat: 33.5905, lng: 130.4195, 
                  note: "ğŸ½ï¸ å¿…é»ï¼šç‰›è’¡å¤©å©¦ç¾…çƒé¾éºµã€‚", bookingRef: "" },
                
                { id: 402, date: "2026-02-17", time: "09:00", type: "transport", title: "å‰å¾€éº’éºŸå•¤é…’å·¥å» ", loc: "ç”˜æœ¨éµé“ å¤ªåˆ€æ´—ç«™", lat: 33.3980, lng: 130.6050, 
                  note: "è·¯ç·šï¼šJRåˆ°ã€ŒåŸºå±±ç«™ã€ -> è½‰ä¹˜ç”˜æœ¨éµé“è‡³ã€Œå¤ªåˆ€æ´—ç«™ã€ã€‚\nâš ï¸ ç”˜æœ¨éµé“åªæ”¶ç¾é‡‘ (Â¥330)ï¼Œè«‹å‚™é›¶éŒ¢ã€‚", bookingRef: "" },
                
                { id: 403, date: "2026-02-17", time: "10:30", type: "sightseeing", title: "éº’éºŸå•¤é…’ç¦å²¡å·¥å» ", loc: "æœå€‰å¸‚", lat: 33.3900, lng: 130.6100, 
                  note: "è²»ç”¨ï¼šÂ¥500 (å«è¦‹å­¸+è©¦é£²)ã€‚éœ€é ç´„ã€‚\nğŸ’¡ç´€å¿µå“ï¼šå•¤é…’æ¯ã€‚", bookingRef: "éœ€é ç´„", link: "https://kirinfactory.my.salesforce-sites.com/ensp/WebSelectEnSp" },
                
                { id: 404, date: "2026-02-17", time: "12:00", type: "food", title: "Kirin Beer Farm", loc: "å·¥å» åœ’å€å…§", lat: 33.3900, lng: 130.6100, 
                  note: "ğŸ½ï¸ å¿…åƒï¼šæˆå‰æ€æ±—çƒ¤è‚‰ (ç¾Šè‚‰)ã€‚", bookingRef: "" },
                
                { id: 405, date: "2026-02-17", time: "15:00", type: "sightseeing", title: "å—è—é™¢ (æ¶…æ§ƒä½›)", loc: "ç¯ æ —ç”º", lat: 33.6190, lng: 130.5730, 
                  note: "ã€äº¤é€šã€‘å¤ªåˆ€æ´— -> åŸºå±± -> JRåšå¤š (è½‰ç¯ æ —ç·š) -> åŸæˆ¶å—è—é™¢å‰ç«™ã€‚\nä¸–ç•Œæœ€å¤§é’éŠ…é‡‹è¿¦æ¶…æ§ƒä½›ã€‚åƒæ‹œè²»Â¥300ã€‚", bookingRef: "" },
                
                { id: 406, date: "2026-02-17", time: "18:30", type: "food", title: "æµ·é¢¨åœŸ (Seafood)", loc: "åšå¤šé§…æ±2-4-17", lat: 33.5908, lng: 130.4230, 
                  note: "ã€äº¤é€šã€‘åšå¤šç«™ç­‘ç´«å£å³è½‰ï¼Œæ²¿åšå¤šé§…æ±è¡—èµ°200ç±³ï¼Œéè·¯å£å·¦æ‰‹é‚Šã€‚\nğŸ½ï¸ å¿…é»ï¼šæµ·ä¹‹å¯¶ç®±ç”Ÿé­šç‰‡(500å††)ã€èƒ¡éº»é¯–é­šã€‚", bookingRef: "" },

                // Day 5: Feb 18 (Wed) - Beppu
                { id: 501, date: "2026-02-18", time: "07:30", type: "food", title: "æ±ç­‘è»’ é›è‚‰é£¯ä¾¿ç•¶", loc: "åšå¤šç«™ä¸­å¤®æ”¹æœ­å£", lat: 33.5900, lng: 130.4205, 
                  note: "å¿…è²·ï¼šæ±ç­‘è»’ ã‹ã—ã‚ã‚ã— (Â¥1,000)ã€‚è»Šä¸Šäº«ç”¨ã€‚", bookingRef: "" },
                
                { id: 502, date: "2026-02-18", time: "08:00", type: "transport", title: "ç‰¹æ€¥ Sonic å¾€åˆ¥åºœ", loc: "JRåšå¤šç«™", lat: 33.5900, lng: 130.4205, 
                  note: "è»Šç¨‹ç´„2å°æ™‚ã€‚è«‹äº‹å…ˆè²·ç¥¨æˆ–ç”¨ICå¡ã€‚", bookingRef: "Sonic" },
                
                { id: 503, date: "2026-02-18", time: "10:20", type: "sightseeing", title: "å¤§åˆ†é¦™æ°´åšç‰©é¤¨", loc: "åˆ¥åºœ", lat: 33.3080, lng: 131.4900, 
                  note: "ã€äº¤é€šã€‘åˆ¥åºœç«™è¥¿å£æ­é¾œä¹‹äº•å·´å£«(2/5/7/41è™Ÿ)è‡³ã€Œåˆ¥åºœå¤§å­¸ä¸‹ã€ã€‚\nèª¿é¦™é«”é©— Â¥2,500ã€‚", bookingRef: "" },
                
                { id: 504, date: "2026-02-18", time: "13:00", type: "food", title: "Beppu Brewery", loc: "åˆ¥åºœç«™å‰", lat: 33.2790, lng: 131.5000, 
                  note: "ã€äº¤é€šã€‘åˆ¥åºœç«™å‰å·¦è½‰æ²¿é§…å‰è¡—èµ°5åˆ†ã€‚\nğŸ½ï¸ å¿…é»ï¼šå•¤é…’è©¦é£²çµ„ã€ç‚¸é›å¤©å©¦ç¾…ã€‚", bookingRef: "" },
                
                { id: 505, date: "2026-02-18", time: "15:00", type: "other", title: "ç«¹ç“¦æº«æ³‰ (ç ‚æ¹¯)", loc: "åˆ¥åºœå¸‚å…ƒç”º", lat: 33.2780, lng: 131.5050, 
                  note: "ã€äº¤é€šã€‘æ²¿å…ƒç”ºè¡—ç›´èµ°10åˆ†ã€‚\né«”é©—ï¼šç†±ç ‚æ’æ¯’ã€‚è²»ç”¨ Â¥1,500ã€‚", bookingRef: "" },
                
                { id: 506, date: "2026-02-18", time: "19:30", type: "food", title: "åšå¤šä¸€é›™ æ‹‰éºµ", loc: "åšå¤šé§…æ±3-1-6", lat: 33.5895, lng: 130.4250, 
                  note: "ã€äº¤é€šã€‘åšå¤šç«™ç­‘ç´«å£å³è½‰ï¼Œæ²¿æ±3è¡—èµ°5åˆ†ã€‚\nğŸ½ï¸ å¿…é»ï¼šç³–å¿ƒè›‹æ‹‰éºµ (å‘³ç‰ãƒ©ãƒ¼ãƒ¡ãƒ³)ã€‚", bookingRef: "" },

                // Day 6: Feb 19 (Thu) - Handmade Experience
                { id: 601, date: "2026-02-19", time: "10:00", type: "sightseeing", title: "Haku Haku æ˜å¤ªå­æ‰‹ä½œ", loc: "å‰å¡š", lat: 33.6080, lng: 130.4280, 
                  note: "ã€äº¤é€šã€‘JRåšå¤š -> å‰å¡šç«™ (1ç«™)ï¼Œæ±å£ç›´èµ°13åˆ†é˜ã€‚\néœ€é ç´„ (ç´„Â¥2,200)ã€‚", bookingRef: "éœ€é ç´„", link: "https://www.hakuhaku.com/workshop/" },
                
                { id: 602, date: "2026-02-19", time: "11:45", type: "shopping", title: "å¸‚å·é¦™èˆ– (ç·šé¦™)", loc: "å·ç«¯å•†åº—è¡—", lat: 33.5930, lng: 130.4080, 
                  note: "ã€äº¤é€šã€‘å‰å¡šå›åšå¤š -> åœ°éµã€Œä¸­æ´²å·ç«¯ç«™ã€5è™Ÿå‡ºå£ã€‚\næŒ‘é¸æ—¥æœ¬è£½é«˜ç´šç·šé¦™ã€‚", bookingRef: "" },
                
                { id: 603, date: "2026-02-19", time: "12:30", type: "food", title: "ç‡’è‚‰ BAKURO å¤§ååº—", loc: "å¤§å", lat: 33.5875, lng: 130.3950, 
                  note: "ã€äº¤é€šã€‘åœ°éµã€Œèµ¤å‚ç«™ã€å‡ºç«™èµ°5åˆ†ã€‚\nğŸ½ï¸ å¿…é»ï¼šåˆé–“ç‡’è‚‰å¥—é¤ (CPå€¼é«˜)ã€‚", bookingRef: "å»ºè­°é ç´„" },
                
                { id: 604, date: "2026-02-19", time: "14:00", type: "shopping", title: "AEON Shoppers ç¦å²¡åº—", loc: "å¤©ç¥", lat: 33.5920, lng: 130.3980, 
                  note: "ã€äº¤é€šã€‘æ²¿å¤©ç¥è¡—ç›´èµ°10-12åˆ†ã€‚\nå¤§å‹è¶…å¸‚ï¼Œå¯é€€ç¨…ã€‚", bookingRef: "" },
                
                { id: 605, date: "2026-02-19", time: "16:30", type: "sightseeing", title: "MY ONLY FRAGRANCE", loc: "å¤§å", lat: 33.5860, lng: 130.3960, 
                  note: "è£½ä½œå°ˆå±¬é¦™æ°´é«”é©—ã€‚\né ç®—ï¼šÂ¥5,000èµ·ã€‚", bookingRef: "éœ€é ç´„", link: "https://myonlyfragrance.com/reservation/" },
                
                { id: 606, date: "2026-02-19", time: "19:00", type: "food", title: "çƒé¾éºµ å’ŒåŠ©", loc: "å¤©ç¥", lat: 33.5900, lng: 130.3990, 
                  note: "ğŸ½ï¸ å¿…é»ï¼šç‰›è’¡å¤©å©¦ç¾…çƒé¾éºµã€‚", bookingRef: "" },

                // Day 7: Feb 20 (Fri) - Departure
                { id: 701, date: "2026-02-20", time: "10:00", type: "food", title: "Nana's Green Tea", loc: "JRåšå¤šåŸ Amu Plaza", lat: 33.5898, lng: 130.4207, 
                  note: "Check-outå¾Œå¯„æ”¾è¡Œæã€‚\nğŸ½ï¸ å¿…åƒï¼šæŠ¹èŒ¶ç”Ÿå·§å…‹åŠ›èŠ­è²ã€‚", bookingRef: "" },
                
                { id: 702, date: "2026-02-20", time: "11:00", type: "sightseeing", title: "çŸ³è—é…’é€  åšå¤šç™¾å¹´è—", loc: "åšå¤šåŒºå …ç²•", lat: 33.6020, lng: 130.4220, 
                  note: "ã€äº¤é€šã€‘åšå¤šå£å·¦è½‰æ²¿å …ç²•è¡—ç›´èµ°20åˆ† (æˆ–æ­å·´å£«)ã€‚\nå…è²»åƒè§€ï¼Œè©¦é£²Â¥300èµ·ã€‚", bookingRef: "", link: "https://www.ishikura-shuzou.co.jp/" },
                
                { id: 703, date: "2026-02-20", time: "12:15", type: "food", title: "é®¨ å‰²çƒ¹ ã‚„ã¾ä¸­", loc: "JRåšå¤šåŸ 9F", lat: 33.5898, lng: 130.4207, 
                  note: "ğŸ½ï¸ å¿…åƒï¼šç‰¹é¸æ¡å£½å¸å¥—é¤ã€‚\nğŸ’° é ç®—ï¼šÂ¥4,000-Â¥6,000ã€‚\nâš ï¸ å‹™å¿…é ç´„ 12:15ã€‚", bookingRef: "å‹™å¿…é ç´„", link: "https://tabelog.com/en/fukuoka/A4001/A400101/40026334/" },
                
                { id: 704, date: "2026-02-20", time: "14:00", type: "transport", title: "å‰å¾€æ©Ÿå ´", loc: "åšå¤šå·´å£«ç¸½ç«™ 11è™Ÿæœˆå°", lat: 33.5915, lng: 130.4190, 
                  note: "æ­ä¹˜ã€Œç¦å²¡æ©Ÿå ´åœ‹éš›ç·š ç›´é”å·´å£«ã€(Â¥310)ã€‚", bookingRef: "" },
                
                { id: 705, date: "2026-02-20", time: "14:30", type: "flight", title: "æŠµé”æ©Ÿå ´ (UO669)", loc: "Fukuoka Airport", lat: 33.5859, lng: 130.4446, 
                  note: "è¾¦ç†ç™»æ©Ÿï¼Œèµ·é£›æ™‚é–“ 16:05ã€‚", bookingRef: "UO669" }
            ]
        };

        const CATS = {
            sightseeing: { label: "æ™¯é»", icon: "fa-camera", color: "text-green-600", bg: "bg-green-100" },
            transport: { label: "äº¤é€š", icon: "fa-train", color: "text-blue-600", bg: "bg-blue-100" },
            flight: { label: "èˆªç­", icon: "fa-plane-up", color: "text-sky-600", bg: "bg-sky-100" },
            food: { label: "ç¾é£Ÿ", icon: "fa-utensils", color: "text-orange-600", bg: "bg-orange-100" },
            shopping: { label: "è³¼ç‰©", icon: "fa-bag-shopping", color: "text-pink-600", bg: "bg-pink-100" },
            other: { label: "å…¶ä»–", icon: "fa-star", color: "text-purple-600", bg: "bg-purple-100" }
        };

        let db = { itinerary: [], expenses: [], shopping: [], todo: [], luggage: [], info: [], settings: { safetyContact: "" } };
        let state = { date: CONFIG.dates[0], tab: 'itinerary', currentList: null, currentItem: null };
        let map = null, markers = [];

        // --- CORE ---
        function init() {
            const saved = localStorage.getItem(CONFIG.key);
            if (saved) db = JSON.parse(saved);
            else {
                db.itinerary = CONFIG.defaultItinerary;
                db.luggage = ["ICå¡ (Suica/ICOCA)", "ç¾é‡‘ (LOPIA/ç”˜æœ¨éµé“/Â¥20000+)", "ç¿»è­¯App", "èˆ’é©é‹å­", "è­·ç…§", "ç¶²å¡", "å……é›»å™¨", "ä¿é¤Šå“", "é˜²ç‹¼è­¦å ±å™¨"].map((t,i)=>({id:i, text:t, done:false}));
            }
            if(!db.settings) db.settings = { safetyContact: "" };
            
            // Restore Safety Contact
            if(db.settings.safetyContact) document.getElementById('safety-contact').value = db.settings.safetyContact;

            renderDateSlider();
            renderAll();
            document.getElementById('rate-display').innerText = CONFIG.rate;
            fetchWeather();
        }

        function save() { localStorage.setItem(CONFIG.key, JSON.stringify(db)); renderAll(); }
        function renderAll() { renderItinerary(); renderExpenses(); renderInfo(); updateBadges(); }

        // --- SAFETY FEATURES ---
        function saveContact() {
            const val = document.getElementById('safety-contact').value;
            db.settings.safetyContact = val;
            save();
            alert("ç·Šæ€¥è¯çµ¡äººå·²å„²å­˜ï¼");
        }

        function sendWhatsAppSOS() {
            const contact = db.settings.safetyContact;
            if(!contact) { alert("è«‹å…ˆè¼¸å…¥è¯çµ¡äººé›»è©±ï¼"); return; }
            
            if(navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (p) => {
                        const lat = p.coords.latitude;
                        const lng = p.coords.longitude;
                        const mapLink = `https://www.google.com/maps?q=${lat},${lng}`;
                        const msg = `ã€ç·Šæ€¥å ±å¹³å®‰ã€‘æˆ‘ç¾åœ¨åœ¨é€™è£¡ï¼Œä¸€åˆ‡å¹³å®‰ã€‚\nä½ç½®ï¼š${mapLink}`;
                        const url = `https://wa.me/${contact}?text=${encodeURIComponent(msg)}`;
                        window.location.href = url;
                    },
                    (e) => {
                        alert("ç„¡æ³•å–å¾—ä½ç½®ï¼Œå°‡ç™¼é€ç´”æ–‡å­—è¨Šæ¯ã€‚");
                        const url = `https://wa.me/${contact}?text=${encodeURIComponent("ã€ç·Šæ€¥å ±å¹³å®‰ã€‘æˆ‘ç¾åœ¨å¾ˆå®‰å…¨ï¼Œä½†ç„¡æ³•å–å¾— GPS ä½ç½®ã€‚")}`;
                        window.location.href = url;
                    }
                );
            } else {
                alert("ç€è¦½å™¨ä¸æ”¯æ´å®šä½");
            }
        }

        let audioContext = null;
        let oscillator = null;
        let isSirenOn = false;

        function toggleSiren() {
            const btn = document.getElementById('siren-btn');
            const txt = document.getElementById('siren-text');
            
            if (isSirenOn) {
                if(oscillator) { oscillator.stop(); oscillator.disconnect(); oscillator = null; }
                isSirenOn = false;
                btn.classList.remove('siren-active');
                txt.innerText = "å•Ÿå‹•é˜²ç‹¼è­¦å ± (æœ€å¤§è²)";
            } else {
                if (!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.type = 'sawtooth';
                oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                oscillator.frequency.linearRampToValueAtTime(1200, audioContext.currentTime + 0.3);
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                const lfo = audioContext.createOscillator();
                lfo.type = 'square';
                lfo.frequency.value = 4;
                const lfoGain = audioContext.createGain();
                lfoGain.gain.value = 400;
                lfo.connect(lfoGain);
                lfoGain.connect(oscillator.frequency);
                lfo.start();

                oscillator.start();
                
                isSirenOn = true;
                btn.classList.add('siren-active');
                txt.innerText = "è­¦å ±éŸ¿èµ·ä¸­ï¼é»æ“Šé—œé–‰";
            }
        }

        function openNearby(type) {
            if(navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(p => {
                    const lat = p.coords.latitude;
                    const lng = p.coords.longitude;
                    let query = "";
                    if(type === 'police') query = "äº¤ç•ª";
                    else if(type === 'hospital') query = "ç—…é™¢";
                    else query = "ã‚³ãƒ³ãƒ“ãƒ‹";
                    window.open(`https://www.google.com/maps/search/${query}/@${lat},${lng},15z`);
                });
            } else {
                alert("è«‹å…è¨±å®šä½æ¬Šé™");
            }
        }

        // --- ITINERARY ---
        function renderDateSlider() {
            const el = document.getElementById('date-slider');
            el.innerHTML = CONFIG.dates.map(d => {
                const dateObj = new Date(d);
                const day = dateObj.getDate();
                const week = dateObj.toLocaleDateString('zh-HK',{weekday:'short'});
                const active = d === state.date ? "bg-jp-text text-white shadow-lg scale-105" : "bg-white text-gray-300";
                return `<button onclick="setDate('${d}')" class="flex-shrink-0 flex flex-col items-center justify-center w-14 h-16 rounded-2xl transition-all duration-300 ${active}">
                    <span class="text-[10px] opacity-80">${week}</span><span class="text-xl font-bold font-mono">${day}</span>
                </button>`;
            }).join('');
        }
        function setDate(d) { state.date = d; renderDateSlider(); renderItinerary(); renderExpenses(); updateMap(); }

        function renderItinerary() {
            const list = document.getElementById('itinerary-list');
            const items = db.itinerary.filter(i => i.date === state.date).sort((a,b) => a.time.localeCompare(b.time));
            if(items.length === 0) { list.innerHTML = `<div class="text-center py-12"><div class="text-6xl text-gray-200 mb-4"><i class="fa-solid fa-mug-hot"></i></div><p class="text-gray-400 text-sm">ä»Šå¤©æƒ³åšé»ä»€éº¼ï¼Ÿ</p></div>`; return; }
            list.innerHTML = items.map(i => {
                const cat = CATS[i.type] || CATS.other;
                return `<div onclick="openDetail(${i.id})" class="bg-white p-4 rounded-3xl shadow-[0_2px_15px_rgba(0,0,0,0.03)] flex gap-4 items-center group active:scale-[0.98] transition cursor-pointer border border-transparent hover:border-gray-100">
                    <div class="flex flex-col items-center gap-1 w-12 font-mono text-gray-400 text-sm font-bold"><span>${i.time}</span>${i.bookingRef ? '<i class="fa-solid fa-circle text-[6px] text-jp-accent"></i>' : ''}</div>
                    <div class="w-12 h-12 rounded-2xl ${cat.bg} ${cat.color} flex items-center justify-center text-lg shadow-sm"><i class="fa-solid ${cat.icon}"></i></div>
                    <div class="flex-1 min-w-0"><h3 class="font-bold text-jp-text truncate text-base">${i.title}</h3><div class="text-xs text-gray-400 truncate"><i class="fa-solid fa-location-dot mr-1 opacity-50"></i>${i.loc || 'æœªè¨­å®šåœ°é»'}</div></div>
                </div>`;
            }).join('');
            new Sortable(list, { animation: 150, handle: '.group' });
        }

        // --- DETAILS ---
        function openDetail(id) {
            const item = db.itinerary.find(i => i.id === id);
            if(!item) return;
            state.currentItem = item;
            const cat = CATS[item.type] || CATS.other;
            document.getElementById('detail-title').innerText = item.title;
            document.getElementById('detail-time').innerText = `${item.date} Â· ${item.time}`;
            document.getElementById('detail-icon').className = `fa-solid ${cat.icon} ${cat.color}`;
            document.getElementById('detail-icon-bg').className = `w-20 h-20 rounded-full flex items-center justify-center text-3xl mb-4 shadow-lg ring-4 ring-white ${cat.bg}`;
            document.getElementById('detail-loc').innerText = item.loc || "é»æ“Šæœå°‹åœ°åœ–";
            document.getElementById('detail-note').innerText = item.note || "ï¼ˆæš«ç„¡å‚™è¨»ï¼‰";
            
            // Handle Link Button
            const linkBtn = document.getElementById('detail-link');
            if (item.link) {
                linkBtn.href = item.link;
                linkBtn.classList.remove('hidden');
            } else {
                linkBtn.classList.add('hidden');
            }

            const bk = document.getElementById('detail-booking-container');
            if(item.bookingRef) { 
                bk.classList.remove('hidden'); 
                document.getElementById('detail-bk-ref').innerText = item.bookingRef; 
                document.getElementById('detail-bk-platform').innerText = item.bookingPlatform || 'é ç´„è³‡è¨Š'; 
            } else { 
                bk.classList.add('hidden'); 
            }
            document.getElementById('detail-modal').classList.remove('hidden');
        }
        function closeDetailModal() { document.getElementById('detail-modal').classList.add('hidden'); }
        function openExternalMap() { const i = state.currentItem; if(i.lat) window.open(`https://www.google.com/maps/search/?api=1&query=${i.lat},${i.lng}`); else window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(i.loc || i.title + " Fukuoka")}`); }
        function deleteFromDetail() { if(confirm("ç¢ºå®šåˆªé™¤æ­¤è¡Œç¨‹ï¼Ÿ")) { db.itinerary = db.itinerary.filter(i => i.id !== state.currentItem.id); save(); closeDetailModal(); } }

        // --- MAP ---
        function updateMap() {
            if(state.tab !== 'map') return;
            if(!map) { map = L.map('osm-map', { zoomControl: false }).setView(CONFIG.hotel.coords, 12); L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', { attribution: '' }).addTo(map); }
            map.invalidateSize();
            markers.forEach(m => map.removeLayer(m)); markers = [];
            const items = db.itinerary.filter(i => i.date === state.date && i.lat);
            L.marker(CONFIG.hotel.coords, {icon: L.divIcon({ html: '<div class="w-8 h-8 bg-black text-white rounded-full flex items-center justify-center shadow-lg border-2 border-white"><i class="fa-solid fa-bed"></i></div>', className: '' })}).addTo(map).bindPopup("<b>Home</b>");
            items.forEach(i => { const cat = CATS[i.type] || CATS.other; const c = cat.color.replace('text-', 'bg-').replace('600', '500'); const m = L.marker([i.lat, i.lng], {icon: L.divIcon({ html: `<div class="w-8 h-8 ${c} text-white rounded-full flex items-center justify-center shadow-lg border-2 border-white"><i class="fa-solid ${cat.icon} text-xs"></i></div>`, className: '' })}).addTo(map).bindPopup(i.title); markers.push(m); });
            document.getElementById('map-status').innerText = `é¡¯ç¤º ${items.length} å€‹åœ°é»`;
            if(items.length > 0) {
                 const group = new L.featureGroup([L.marker(CONFIG.hotel.coords), ...markers]);
                 map.fitBounds(group.getBounds().pad(0.1));
            }
        }
        function refreshMap() { setTimeout(updateMap, 300); }

        // --- EXPENSES ---
        function renderExpenses() {
            const list = document.getElementById('expense-list');
            const items = db.expenses.filter(i => i.date === state.date);
            let totalF = 0, totalH = 0;
            list.innerHTML = items.map(i => {
                const amt = parseFloat(i.amount);
                if(i.curr === 'JPY') totalF += amt; else totalH += amt;
                return `<div class="bg-white px-4 py-3 rounded-2xl flex justify-between items-center shadow-sm border border-gray-50"><span class="text-jp-text font-bold">${i.desc}</span><div class="text-right"><div class="font-bold text-jp-text text-lg">${i.curr === 'JPY' ? 'Â¥' : '$'} ${amt.toLocaleString()}</div><button onclick="deleteExpense(${i.id})" class="text-[10px] text-red-300">åˆªé™¤</button></div></div>`;
            }).join('');
            document.getElementById('daily-total-foreign').innerText = totalF.toLocaleString();
            document.getElementById('daily-total-home').innerText = Math.round(totalF * CONFIG.rate + totalH).toLocaleString();
        }
        function deleteExpense(id) { db.expenses = db.expenses.filter(i => i.id !== id); save(); }

        // --- LISTS & INFO ---
        function openModal(type) {
            if(type === 'trip-info') { document.getElementById('modal-trip-info').classList.remove('hidden'); return; }
            if(type === 'converter') { document.getElementById('modal-converter').classList.remove('hidden'); return; }
            if(type === 'safety') { document.getElementById('modal-safety').classList.remove('hidden'); return; }
            state.currentList = type;
            const config = { luggage: {t:'è¡Œææ¸…å–®', i:'suitcase'}, shopping: {t:'è³¼ç‰©æ¸…å–®', i:'bag-shopping'}, todo: {t:'å¾…è¾¦äº‹é …', i:'check-circle'} };
            const c = config[type];
            document.getElementById('generic-title').innerHTML = `<i class="fa-solid fa-${c.i} text-jp-accent"></i> ${c.t}`;
            renderGenericList();
            document.getElementById('modal-generic').classList.remove('hidden');
            toggleMainMenu();
        }
        function closeGenericModal() { document.getElementById('modal-generic').classList.add('hidden'); }
        function renderGenericList() {
            const type = state.currentList;
            const list = db[type] || [];
            document.getElementById('generic-list').innerHTML = list.map(i => `
                <li class="flex items-center gap-3 bg-white p-3 rounded-xl border border-gray-50 shadow-sm transition-all ${i.done ? 'opacity-50 grayscale' : ''}">
                    <div onclick="toggleItem('${type}', ${i.id})" class="w-6 h-6 rounded-full border-2 ${i.done ? 'bg-jp-accent border-jp-accent' : 'border-gray-300'} flex items-center justify-center text-white text-xs cursor-pointer"><i class="fa-solid fa-check ${i.done?'':'hidden'}"></i></div>
                    <span class="flex-1 font-medium ${i.done?'line-through':''}">${i.text}</span>
                    <button onclick="deleteListItem('${type}', ${i.id})" class="text-gray-300 px-2"><i class="fa-solid fa-xmark"></i></button>
                </li>
            `).join('');
        }
        function addGenericItem() { const inp = document.getElementById('generic-input'); if(!inp.value) return; if(!db[state.currentList]) db[state.currentList] = []; db[state.currentList].push({ id: Date.now(), text: inp.value, done: false }); inp.value = ''; save(); renderGenericList(); }
        function toggleItem(t, id) { const i = db[t].find(x=>x.id===id); if(i) i.done=!i.done; save(); renderGenericList(); }
        function deleteListItem(t, id) { db[t] = db[t].filter(x=>x.id!==id); save(); renderGenericList(); }
        function renderInfo() {
            document.getElementById('info-list').innerHTML = db.info.map(i => `
                <div class="bg-white p-5 rounded-2xl shadow-sm border-l-4 border-jp-accent relative">
                    <button onclick="deleteInfo(${i.id})" class="absolute top-4 right-4 text-gray-200"><i class="fa-solid fa-xmark"></i></button>
                    <h3 class="font-bold text-lg text-jp-text mb-2">${i.title}</h3>
                    <p class="text-sm text-gray-500 whitespace-pre-line leading-relaxed">${i.content}</p>
                </div>
            `).join('');
        }
        function deleteInfo(id) { if(confirm("åˆªé™¤ç­†è¨˜ï¼Ÿ")) { db.info = db.info.filter(x=>x.id!==id); save(); } }

        // --- FORMS ---
        function openAddModal(type) {
            state.addType = type;
            document.getElementById('add-modal').classList.remove('hidden');
            const c = document.getElementById('modal-content');
            if(type === 'itinerary') {
                c.innerHTML = `
                    <div class="grid grid-cols-3 gap-3"><div class="bg-gray-50 p-2 rounded-xl border border-gray-100"><label class="text-[10px] text-gray-400 block mb-1">æ™‚é–“</label><input type="time" name="time" class="bg-transparent w-full font-bold outline-none" required></div><div class="col-span-2 bg-gray-50 p-2 rounded-xl border border-gray-100"><label class="text-[10px] text-gray-400 block mb-1">é¡å‹</label><select name="type" class="bg-transparent w-full font-bold outline-none">${Object.entries(CATS).map(([k,v])=>`<option value="${k}">${v.label}</option>`).join('')}</select></div></div>
                    <input type="text" name="title" placeholder="æ¨™é¡Œ" class="w-full bg-gray-50 p-4 rounded-xl outline-none border border-gray-100 font-bold placeholder-gray-300" required>
                    <input type="text" name="loc" placeholder="åœ°é» (é¸å¡«)" class="w-full bg-gray-50 p-4 rounded-xl outline-none border border-gray-100 text-sm">
                    <div class="p-3 bg-orange-50 rounded-xl border border-orange-100"><div class="text-xs text-orange-400 font-bold mb-1">é ç´„è³‡è¨Š</div><input type="text" name="bookingRef" placeholder="ä»£è™Ÿ / å‚™è¨»" class="w-full bg-white p-2 rounded-lg text-sm outline-none"></div>
                    <textarea name="note" placeholder="å‚™è¨»..." class="w-full bg-gray-50 p-4 rounded-xl outline-none border border-gray-100 h-24 resize-none"></textarea>
                    <input type="url" name="link" placeholder="ç›¸é—œé€£çµ (é¸å¡«)" class="w-full bg-gray-50 p-4 rounded-xl outline-none border border-gray-100 text-sm mt-2">
                `;
            } else if (type === 'expense') {
                c.innerHTML = `<input type="text" name="desc" placeholder="é …ç›®" class="w-full bg-gray-50 p-4 rounded-xl font-bold outline-none" required><div class="flex gap-3"><input type="number" name="amount" placeholder="0" class="flex-1 bg-gray-50 p-4 rounded-xl font-bold text-xl outline-none" required><select name="curr" class="w-24 bg-jp-text text-white rounded-xl font-bold outline-none text-center"><option value="JPY">Â¥</option><option value="HKD">$</option></select></div>`;
            } else { c.innerHTML = `<input type="text" name="title" placeholder="æ¨™é¡Œ" class="w-full bg-gray-50 p-4 rounded-xl font-bold outline-none" required><textarea name="content" placeholder="å…§å®¹..." class="w-full bg-gray-50 p-4 rounded-xl outline-none h-32 mt-2 resize-none"></textarea>`; }
        }
        function closeAddModal() { document.getElementById('add-modal').classList.add('hidden'); }
        async function handleFormSubmit(e) {
            e.preventDefault(); const data = Object.fromEntries(new FormData(e.target)); data.id = Date.now();
            if(state.addType === 'itinerary') { data.date = state.date; if(data.loc) { try { const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(data.loc + " Fukuoka")}`); const r = await res.json(); if(r[0]) { data.lat = parseFloat(r[0].lat); data.lng = parseFloat(r[0].lon); } } catch(e){} } db.itinerary.push(data); }
            else if (state.addType === 'expense') { data.date = state.date; db.expenses.push(data); } else db.info.push(data);
            save(); closeAddModal();
        }

        // --- UTILS ---
        function toggleMainMenu() { const m = document.getElementById('main-menu'), o = document.getElementById('menu-overlay'); if(m.classList.contains('hidden')) { m.classList.remove('hidden'); o.classList.remove('hidden'); setTimeout(()=>m.classList.remove('opacity-0', 'scale-95'), 10); } else { m.classList.add('opacity-0', 'scale-95'); setTimeout(()=>m.classList.add('hidden'), 200); o.classList.add('hidden'); } }
        function switchTab(t) { state.tab = t; ['itinerary', 'map', 'finance', 'info'].forEach(x => document.getElementById(`view-${x}`).classList.add('hidden')); document.getElementById(`view-${t}`).classList.remove('hidden'); document.querySelectorAll('.nav-btn').forEach(b => { b.classList.remove('text-jp-accent', 'active'); b.classList.add('text-gray-300'); }); const btn = document.querySelector(`button[onclick="switchTab('${t}')"]`); btn.classList.remove('text-gray-300'); btn.classList.add('text-jp-accent', 'active'); if(t==='map') refreshMap(); }
        function openTaxiCard() { document.getElementById('modal-taxi').classList.remove('hidden'); }
        function closeModal(t) { document.getElementById(`modal-${t}`).classList.add('hidden'); }
        function convertCurrency(s) { const f = document.getElementById('conv-foreign'), h = document.getElementById('conv-home'); if(s==='foreign') h.value = (f.value * CONFIG.rate).toFixed(1); else f.value = (h.value / CONFIG.rate).toFixed(0); }
        function updateBadges() { const c = (db.shopping||[]).filter(i=>!i.done).length + (db.luggage||[]).filter(i=>!i.done).length; const el = document.getElementById('global-badge'); if(c>0) el.classList.remove('hidden'); else el.classList.add('hidden'); }
        function exportData() { const s = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(db)); const n = document.createElement('a'); n.setAttribute("href", s); n.setAttribute("download", `trip_backup_${new Date().toISOString().slice(0,10)}.json`); document.body.appendChild(n); n.click(); n.remove(); }
        function importData(i) { const f = i.files[0]; if(!f) return; const r = new FileReader(); r.onload = function(e) { try { db = JSON.parse(e.target.result); save(); alert("å·²é‚„åŸï¼"); window.location.reload(); } catch(e) { alert("æ ¼å¼éŒ¯èª¤"); } }; r.readAsText(f); }
        async function fetchWeather() { try { const r = await fetch("https://api.open-meteo.com/v1/forecast?latitude=33.59&longitude=130.42&current_weather=true&timezone=Asia%2FTokyo"); const d = await r.json(); if(d.current_weather) { document.getElementById('weather-widget').classList.remove('hidden'); document.getElementById('weather-temp').innerText = `${Math.round(d.current_weather.temperature)}Â°C`; const c = d.current_weather.weathercode; let i = "fa-cloud", t = "é™°å¤©"; if(c <= 3) { i="fa-sun"; t="æ™´æœ—"; } else if(c >= 50) { i="fa-umbrella"; t="æœ‰é›¨"; } document.getElementById('weather-icon').innerHTML = `<i class="fa-solid ${i}"></i>`; document.getElementById('weather-desc').innerText = t; } } catch(e){} }

        init();
    </script>
</body>
</html>
